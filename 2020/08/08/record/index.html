<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>rainmeter皮肤google翻译工具编写 | 日常点滴</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/hexo/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="日常点滴">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml">
  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="rss.xml">
  
  

  
</head>


<body class="post-template">

  <header class="site-head"  style="background-image: url(/image/cover.png)" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/hexo/"><img src="https://avatars.githubusercontent.com/u/26755276" alt="Blog Logo"/></a> 
            <h1 class="blog-title">日常点滴</h1>
            <h2 class="blog-description"></h2>
        </div>
    </div>
</header>
  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2020-08-08T11:59:06.842Z" itemprop="datePublished">
          2020-08-08
      </time>
    
    
    | 
    <a href='/hexo/tags/javascript/'>javascript</a>,
    
    <a href='/hexo/tags/rainmeter/'>rainmeter</a>,
    
    <a href='/hexo/tags/python/'>python</a>
    
    
</span>
    <h1 class="post-title">rainmeter皮肤google翻译工具编写</h1>
    <section class="post-content">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" /><h1>前言</h1>
<p>由于写代码起变量名有时需要查翻译，但每次都要打开关闭一个 google 翻译页面非常不方便，因此想做一个一直处于屏幕顶部的随时可用的 google 翻译工具栏。</p>
<p>以下为经验记录</p>
<a id="more"></a>
<h1>先说结论</h1>
<p>效果如下</p>
<p><img src="/hexo/image/result.gif" alt="图片无法显示"></p>
<h1>本文中的内容概述</h1>
<ol>
<li>rainmeter 皮肤编写。</li>
<li>看rainmeter文档时，由于加载比较慢，用 python 写代理程序转发请求用来加快文档的网页加载速度。</li>
<li>写 flask 程序时，用代码实时监听文件变化执行特定命令。</li>
<li>gbk 转 unicode</li>
</ol>
<h2 id="rainmeter-皮肤编写">rainmeter 皮肤编写</h2>
<p>用 rainmeter 的 webpaser 发送请求，lua 脚本处理 json、拼接字符串。</p>
<blockquote>
<p>问题：本以为用 lua 脚本会很简单，可以发请求、处理一条龙，用了才知道 lua 本身不支持网络编程，其次 rainmeter 中使用 lua 时，rainmeter 文档明确指出无法使用需外部编译的第三方库，无法用 require 引入文件，只能用 dofile 引入.lua 文件，然后字符串编码还有问题。</p>
</blockquote>
<h2 id="python-转发请求">python 转发请求</h2>
<p>看 rainmter 文档时由于网络问题导致文档加载要半天甚至无法加载。在服务器上用 wget 下载页面很快，因此用 flask 框架写了个 python web 服务端程序通过服务器转发请求。</p>
<h2 id="python-监听文件夹内文件及子文件夹文件变化，python-多进程，python-调用系统命令">python 监听文件夹内文件及子文件夹文件变化，python 多进程，python 调用系统命令</h2>
<p>写转发程序时没认真看 flask 的文档，不知有 debug 模式。写了个 <a href="http://watcher.py" target="_blank" rel="noopener">watcher.py</a>，用于监听当前目录及子目录下文件修改，重启进程。失败了（在完成前发现有 debug 模式），但算是学到点东西。</p>
<h2 id="google-翻译接口调用方法">google 翻译接口调用方法</h2>
<p>从 google 翻译网站上用 network 找的接口</p>
<p>接口调用时可以传一个 tk 参数，传 tk 参数时，返回结果更详细（包括拼音，近义词），不传 tk 返回简略结果。<br>
由于想要详细结果，以及不传参数 tk 时接口返回的中文字符在 rainmeter 中是乱码(不知原因，用 codepage 指定编码没用)，因此需要生成 tk。</p>
<h2 id="js-GBK-乱码处理">js GBK 乱码处理</h2>
<p>rainmeter 用 gbk 格式保存字符，js 字符格式是 utf16，是 unicode 的一种实现，unicode 和 gbk 不兼容，所以 rainmeter 把 gbk 中文发送给 js 后，js 将其当成只有单字节字符的范围属于 0x00~0xff 的 iso-8859-1 编码处理，因此出现乱码。所以还得做编码转换。<br>
gbk unicode 不兼容，转化只能查表，附 json 格式的 gb2312–&gt;unicode 编码映射表。</p>
<h1>详细</h1>
<h2 id="代理请求">代理请求</h2>
<p>请求发到服务器上的 python 程序，由 python 程序将请求转发到真正的地址，并且将响应转发回来</p>
<details>
<summary>python代码</summary>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config.py</span></span><br><span class="line"></span><br><span class="line">rootpath = <span class="string">"/"</span></span><br><span class="line">url = <span class="string">"https://docs.rainmeter.net/"</span></span><br><span class="line"><span class="comment"># url = "https://www.baidu.com"</span></span><br><span class="line"><span class="comment"># 转发哪些header</span></span><br><span class="line">headers_filter = [<span class="string">"User-Agent"</span>, <span class="string">"Content-Type"</span>, <span class="string">"Cookie"</span>, <span class="string">"Accept"</span>,</span><br><span class="line">                  <span class="string">"Accept-Encoding"</span>, <span class="string">"Cache-Control"</span>, <span class="string">"Accept-Language"</span>, <span class="string">"Connection"</span>, <span class="string">"Host"</span>]<span class="comment">#, "Referer"]</span></span><br><span class="line"><span class="comment"># 不转发哪些header</span></span><br><span class="line">headers_filter_exclude = []  <span class="comment"># "Host"]</span></span><br><span class="line"><span class="comment"># 不响应哪些header</span></span><br><span class="line">headers_exclude = [<span class="string">"Set-Cookie"</span>, <span class="string">"Content-Encoding"</span>]</span><br><span class="line"><span class="comment"># 响应哪些header</span></span><br><span class="line">headers_include = [<span class="string">"Server"</span>, <span class="string">"Content-Type"</span>, <span class="string">"Cache-Control"</span>, <span class="string">"Connection"</span>,</span><br><span class="line">                   <span class="string">"Content-Encoding"</span>, <span class="string">"Content-Length"</span>, <span class="string">"Date"</span>, <span class="string">"Pragma"</span>, <span class="string">"Transfer-Encoding"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> werkzeug.routing <span class="keyword">import</span> BaseConverter</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> get_params <span class="keyword">import</span> get_params</span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> get_response</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> rootpath, headers_filter, headers_filter_exclude</span><br><span class="line"></span><br><span class="line"><span class="comment"># flask支持正则匹配路径的实现，copy from https://cloud.tencent.com/developer/article/1519919</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegexConverter</span><span class="params">(BaseConverter)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url_map, *args)</span>:</span></span><br><span class="line">        super(RegexConverter, self).__init__(url_map)</span><br><span class="line">        self.url = url_map</span><br><span class="line">        print(args, url_map)</span><br><span class="line">        self.regex = args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_python</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__+str(random.randint(<span class="number">0</span>, <span class="number">1000</span>)))</span><br><span class="line"></span><br><span class="line">app.url_map.converters[<span class="string">'re'</span>] = RegexConverter</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(rootpath+'&lt;re(r".*"):path&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> get_response(path, params=request.args, method=request.method, data=request.data, headers=get_headers(request.headers.__str__()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_headers</span><span class="params">(headers)</span>:</span></span><br><span class="line">    headers = headers.split(<span class="string">"\r\n"</span>)</span><br><span class="line">    headers = [header.split(<span class="string">": "</span>) <span class="keyword">for</span> header <span class="keyword">in</span> headers <span class="keyword">if</span> len(</span><br><span class="line">        header) &gt; <span class="number">0</span> <span class="keyword">and</span> header <span class="keyword">in</span> headers_filter] <span class="comment">#and header not in headers_filter_exclude ]</span></span><br><span class="line">    dic = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> [name, value] <span class="keyword">in</span> headers:</span><br><span class="line">        dic[name] = value</span><br><span class="line">    <span class="keyword">return</span> dic</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># app.run("127.0.0.1", random.randint(8000, 9000))</span></span><br><span class="line">    dic = get_params((<span class="string">"p:h:"</span>, <span class="keyword">True</span>))</span><br><span class="line">    app.run(dic[<span class="string">"-h"</span>], dic[<span class="string">"-p"</span>], debug=true)</span><br><span class="line">    <span class="comment"># start_server("127.0.0.1", 8100)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_params.py</span></span><br><span class="line"><span class="comment"># 工具函数get_params,获取特定的命令行参数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> getopt <span class="keyword">import</span> getopt, GetoptError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_argv</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="comment"># 处理单个元组</span></span><br><span class="line">    lens = len(t)</span><br><span class="line">    <span class="keyword">if</span> lens == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, []</span><br><span class="line">    lens2 = len(t[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> lens == <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># len(str)==1</span></span><br><span class="line">        <span class="comment"># if lens2 == 1:</span></span><br><span class="line">        <span class="keyword">if</span> lens2 &gt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> t[<span class="number">0</span>], []</span><br><span class="line">        <span class="comment"># ()</span></span><br><span class="line">        <span class="keyword">elif</span> lens2 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>, []</span><br><span class="line">        <span class="comment"># len(str)&gt;1</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     return "", [t[0]]</span></span><br><span class="line">    <span class="keyword">elif</span> lens == <span class="number">2</span>:</span><br><span class="line">        <span class="comment"># (str,True)</span></span><br><span class="line">        <span class="keyword">if</span> t[<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">return</span> t[<span class="number">0</span>], []</span><br><span class="line">        <span class="comment"># (str,False)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>, [t[<span class="number">0</span>]]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># (str,True,any)</span></span><br><span class="line">        <span class="keyword">if</span> t[<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">return</span> t[<span class="number">0</span>], []</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># (str,False,True)</span></span><br><span class="line">            <span class="keyword">if</span> t[<span class="number">2</span>]:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>, [t[<span class="number">0</span>]+<span class="string">"="</span>]</span><br><span class="line">            <span class="comment"># (str,False,False)</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>, [t[<span class="number">0</span>]]</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_argv_list</span><span class="params">(li)</span>:</span></span><br><span class="line">    <span class="comment"># 处理多个元组</span></span><br><span class="line">    def1 = <span class="string">""</span></span><br><span class="line">    def2 = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> li:</span><br><span class="line">        <span class="comment"># get_params((str,bool,bool),(str,bool,bool),...)</span></span><br><span class="line">        <span class="keyword">if</span> type(item) <span class="keyword">is</span> list <span class="keyword">or</span> type(item) <span class="keyword">is</span> tuple:</span><br><span class="line">            a1, a2 = decode_argv(item)</span><br><span class="line">        <span class="comment"># get_params(str,str,...)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            a1, a2 = decode_argv([item])</span><br><span class="line">        def1 += a1</span><br><span class="line">        def2 += a2</span><br><span class="line">    <span class="keyword">return</span> def1, def2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_params</span><span class="params">(*argvs)</span>:</span></span><br><span class="line">    lens = len(argvs)</span><br><span class="line">    def1 = <span class="string">""</span></span><br><span class="line">    def2 = []</span><br><span class="line">    <span class="keyword">if</span> lens == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> type(argvs[<span class="number">0</span>]) <span class="keyword">is</span> tuple:</span><br><span class="line">        <span class="comment"># get_params((str,bool,bool),(str,bool,bool),(str,bool,bool),...)</span></span><br><span class="line">        def1, def2 = decode_argv_list(argvs)</span><br><span class="line">    <span class="keyword">elif</span> type(argvs[<span class="number">0</span>]) <span class="keyword">is</span> dict:</span><br><span class="line">        li = []</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> argvs[<span class="number">0</span>].keys():</span><br><span class="line">            <span class="comment"># get_params(&#123;"arg1":(bool,bool),"arg2":(bool,bool),...&#125;)</span></span><br><span class="line">            <span class="keyword">if</span> type(argvs[<span class="number">0</span>][name]) <span class="keyword">is</span> tuple:</span><br><span class="line">                li.append([name]+list(argvs[<span class="number">0</span>][name]))</span><br><span class="line">            <span class="comment"># get_params(&#123;"arg1":bool,"arg2":bool,...&#125;)</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                li.append([name, argvs[<span class="number">0</span>][name]])</span><br><span class="line">        def1, def2 = decode_argv_list(li)</span><br><span class="line">    <span class="keyword">elif</span> type(argvs[<span class="number">0</span>]) <span class="keyword">is</span> str:</span><br><span class="line">        <span class="comment"># get_params(str,str,...)</span></span><br><span class="line">        <span class="keyword">if</span> lens == <span class="number">1</span> <span class="keyword">or</span> type(argvs[<span class="number">1</span>]) <span class="keyword">is</span> str:</span><br><span class="line">            def1, def2 = decode_argv_list(argvs)</span><br><span class="line">        <span class="comment"># get_params(str,bool,bool)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            def1, def2 = decode_argv(argvs)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"params type error!"</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        opts = getopt(sys.argv[<span class="number">1</span>:], def1, def2)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">except</span> GetoptError:</span><br><span class="line">        print(<span class="string">"getopt error"</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    result = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> opt, arg <span class="keyword">in</span> opts:</span><br><span class="line">        result[opt] = arg</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># get_params()</span></span><br><span class="line">    <span class="comment"># get_params("ova")</span></span><br><span class="line">    <span class="comment"># get_params("ova", True)</span></span><br><span class="line">    <span class="comment"># get_params("")</span></span><br><span class="line">    <span class="comment"># get_params((), ("ova"))</span></span><br><span class="line">    <span class="comment"># print(get_params(&#123;"ova": (True, True)&#125;))</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># web.py</span></span><br><span class="line"><span class="comment"># 发送请求</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> url, headers_exclude, headers_include</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"mozilla/5.0 (windows nt 10.0; win64; x64) applewebkit/537.36 (khtml, like gecko) chrome/84.0.4147.105 safari/537.36"</span></span><br><span class="line">&#125;</span><br><span class="line">params = &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_response</span><span class="params">(path, method=<span class="string">"GET"</span>, params=params, headers=headers, data=<span class="string">""</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> method == <span class="string">"GET"</span>:</span><br><span class="line">        <span class="keyword">return</span> to_flask_response(requests.get(url+path, params=params, headers=headers))</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">"POST"</span>:</span><br><span class="line">        <span class="keyword">return</span> to_flask_response(requests.post(url+path, params=params, headers=headers, data=data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_flask_response</span><span class="params">(res)</span>:</span></span><br><span class="line">    response = Response()</span><br><span class="line">    response.status_code = res.status_code</span><br><span class="line">    <span class="comment"># print(res.headers, "reponse.header", response.headers)</span></span><br><span class="line">    headers = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> res.headers:</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> headers_exclude:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># res.headers[name] = res.headers[name].replace("domain","do")</span></span><br><span class="line">        <span class="comment"># if name in headers_include:</span></span><br><span class="line">        response.headers[name] = res.headers[name]</span><br><span class="line">    response.data = res.content</span><br><span class="line">    print(res.cookies.items())</span><br><span class="line">    <span class="keyword">for</span> name, val <span class="keyword">in</span> res.cookies.items():</span><br><span class="line">        response.set_cookie(name, val)</span><br><span class="line">    <span class="comment"># response.set_cookie(res.cookies)</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    res = requests.get(url, params=params, headers=headers)</span><br><span class="line">    print(res.text)</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
</details>
<h3 id="配置-uwsgi">配置 uwsgi</h3>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; uwsgi.ini</span></span><br><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="comment">#user and group</span></span><br><span class="line"><span class="attr">uid</span> = nginx</span><br><span class="line"><span class="attr">gid</span> = nginx</span><br><span class="line"><span class="comment">#直接部署</span></span><br><span class="line"><span class="comment">#http = 0.0.0.0:8000</span></span><br><span class="line"><span class="comment">#通过nginx设置uwsgi_pass部署</span></span><br><span class="line"><span class="attr">socket</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span></span><br><span class="line"><span class="attr">stats</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8001</span></span><br><span class="line"><span class="attr">master</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">vhost</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">workers</span> = <span class="number">8</span></span><br><span class="line"><span class="attr">reload-mercy</span> = <span class="number">10</span></span><br><span class="line"><span class="attr">vacuum</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">max-requests</span> = <span class="number">10000</span></span><br><span class="line"><span class="attr">limit-as</span> = <span class="number">1024</span></span><br><span class="line"><span class="comment">#64kb</span></span><br><span class="line"><span class="attr">buffer-size</span> = <span class="number">65536</span></span><br><span class="line"><span class="attr">pidfile</span> = /projects/pid/uwsgi.pid</span><br><span class="line"><span class="attr">daemonize</span> = /projects/log/uwsgi.log</span><br><span class="line"><span class="comment">#网页文件路径</span></span><br><span class="line"><span class="attr">chdir</span> = /projects/python</span><br><span class="line"><span class="attr">module</span> = app</span><br><span class="line"><span class="attr">callable</span> = app</span><br><span class="line"><span class="attr">chmod-socket</span> = <span class="number">660</span></span><br><span class="line"><span class="attr">enable-threads</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment">#启动程序</span></span><br><span class="line"><span class="attr">uwsgi-file</span> = /projects/python/app.py</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># nginx.conf</span><br><span class="line">location ~/ &#123;</span><br><span class="line">    uwsgi_pass host_name;</span><br><span class="line">    include uwsgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="遇到的问题">遇到的问题</h3>
<p>设置 http 地址方式部署 uwsgi 时，返回响应不过滤掉<code>Transfer: chunked</code>会导致响应解析失败，找了许久原因，用 postman 请求得到提示<code>Transfer: chunked</code>和<code>Content-Length:</code>冲突，不能同时存在。<br>
但使用 nginx 反向代理到 uwsgi 时，不过滤<code>Transfer:chunked</code>也不会有问题。</p>
<p>曾经写过用 c 处理 http 请求动态生成响应报文的程序，由于无法计算出<code>Content-Length</code>,而不响应<code>Content-Length</code>,改加<code>Transfer:chunked</code>,因为据网上说这个可以代替<code>Content-Length</code>，同样导致报文解析时报错。<br>
因此认为不是<code>Transfer: chunked</code>与<code>Content-Length:</code>冲突，而是<code>Transfer: chunked</code>这个头某些情况会导致报错，具体原因未知</p>
<p>请求转发过程中若是将请求头 headers 原封不动转发，会被检测到问题，响应 403 无权限<br>
原因：服务器会检查 Referer，转发后 Referer 是不匹配的，把 Referer 过滤了或者伪造 Referer</p>
<h2 id="监听文件变化并重启进程">监听文件变化并重启进程</h2>
<p>思路：循环遍历当前文件夹，若文件有改变，将之前创建的子进程关闭，调用<code>python3 app.py -h 127.0.0.1 -p 端口号</code>命令来开启新的子进程</p>
<h3 id="主要代码">主要代码</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># watcher.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> cocurrent <span class="keyword">import</span> ProcessCocurrent, start_process, co_exec</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="comment"># file = open("./watcher.json")</span></span><br><span class="line"><span class="comment"># jsonTxt = file.read()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读配置</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, config_json=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> config_json == <span class="keyword">None</span>:</span><br><span class="line">            self.config_json = json.load(open(<span class="string">"./watcher.json"</span>))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.config_json = config_json</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_exclude</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        exclude_list = self.config_json[<span class="string">"exclude"</span>]</span><br><span class="line">        <span class="keyword">if</span> exclude_list == <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> exclude_list:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> re.search(p, path) == <span class="keyword">None</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_include</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        include_list = self.config_json[<span class="string">"include"</span>]</span><br><span class="line">        <span class="keyword">if</span> include_list == <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> include_list:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> re.search(p, path) == <span class="keyword">None</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_path</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.config_json[<span class="string">"path"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历文件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileScan</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, config=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> config:</span><br><span class="line">            self.config = config</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.config = Config()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_file_list</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> os.listdir(path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_file_list_r</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_dir(path):</span><br><span class="line">            <span class="keyword">if</span> self.config.is_include(path):</span><br><span class="line">                <span class="keyword">return</span> [path]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> []</span><br><span class="line">        file_list = self.get_file_list(path)</span><br><span class="line">        file_list = [</span><br><span class="line">            path+<span class="string">"/"</span>+p <span class="keyword">for</span> p <span class="keyword">in</span> file_list <span class="keyword">if</span> <span class="keyword">not</span> self.config.is_exclude(p)]</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> file_list:</span><br><span class="line">            result += self.get_file_list_r(p)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_dir</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> os.path.isdir(path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_updated</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_change</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 管理进程</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cmd)</span>:</span></span><br><span class="line">        config = Config()</span><br><span class="line">        self.dic = &#123;&#125;</span><br><span class="line">        self.path = config.get_path()</span><br><span class="line">        self.scanner = FileScan(config)</span><br><span class="line">        self.p = <span class="keyword">None</span></span><br><span class="line">        self.cmd = cmd</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="comment"># print("started")</span></span><br><span class="line">            files = self.scanner.get_file_list_r(self.path)</span><br><span class="line">            <span class="comment"># print("watch", files)</span></span><br><span class="line">            <span class="keyword">if</span> self.is_changed(files):</span><br><span class="line">                print(<span class="string">"changed"</span>)</span><br><span class="line">                <span class="keyword">if</span> self.p:</span><br><span class="line">                    print(<span class="string">"kill p"</span>)</span><br><span class="line">                    self.p.kill() <span class="keyword">and</span> self.p.join()</span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">                self.p = ProcessCocurrent()</span><br><span class="line">                self.p.execl(self.cmd)</span><br><span class="line">                print(<span class="string">"started"</span>+str(self.p.pid))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_changed</span><span class="params">(self, files)</span>:</span></span><br><span class="line">        flag = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">for</span> path <span class="keyword">in</span> files:</span><br><span class="line">            state = os.stat(path)</span><br><span class="line">            <span class="keyword">if</span> path <span class="keyword">in</span> self.dic.keys():</span><br><span class="line">                flag |= state.st_mtime != self.dic[path]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flag = <span class="keyword">True</span></span><br><span class="line">            self.dic[path] = state.st_mtime</span><br><span class="line">        <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    Watcher(<span class="string">"cls &amp;&amp;python3 -B app.py -h 127.0.0.1 -p 8100"</span>).start()</span><br></pre></td></tr></table></figure>
<h3 id="多进程及执行命令">多进程及执行命令</h3>
<p>python 中多进程编程库找到有<code>multiprocessing</code>，以及<code>subprocess</code><br>
在 linux 下还可以用<code>os.fork</code>创建进程，用法以目前感觉来说和 c 的 fork 没什么区别<br>
执行命令有<code>os.exec*</code>族,<code>os.system</code>,<code>subprocess.Popen</code>等等</p>
<h4 id="创建子进程">创建子进程</h4>
<ol>
<li>
<p>os.fork<br>
复制一个进程，子进程返回 0，父进程返回子进程 id，可在程序中以此区分父子进程</p>
</li>
<li>
<p>multiprocessing.Process<br>
调用方法两种，直接调用<code>Process(target=要执行函数, args=参数列表)</code><br>
继承调用，例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessCocurrent</span><span class="params">(Process)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, callback=None, *args)</span>:</span></span><br><span class="line">      self.callback = callback</span><br><span class="line">      self.args = args</span><br><span class="line">      super().__init__()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">      <span class="keyword">if</span> self.cmd:</span><br><span class="line">          cmdli = self.cmd.split(<span class="string">" "</span>)</span><br><span class="line">          os.execvp(cmdli[<span class="number">0</span>], cmdli)</span><br><span class="line">      <span class="keyword">if</span> self.callback:</span><br><span class="line">          self.callback(*self.args)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">setCallback</span><span class="params">(self, callback, *args)</span>:</span></span><br><span class="line">      self.callback = callback</span><br><span class="line">      self.args = args</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execl</span><span class="params">(self, cmd)</span>:</span></span><br><span class="line">      self.cmd = cmd</span><br><span class="line">      self.start()</span><br><span class="line">      <span class="keyword">return</span> self</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>其余用法可百度</p>
<h4 id="调用命令">调用命令</h4>
<ol>
<li>
<p><a href="https://www.cnblogs.com/johnyang/p/10888780.html" target="_blank" rel="noopener">os.exec*用法</a>，<code>os.exec*</code>会覆盖当前进程，此句之后的语句不会再执行，windows 上<code>os.exec*</code>执行命令后进程 id 会改变，linux 上不会</p>
</li>
<li>
<p><code>os.system</code>相当于在命令行下执行某个命令，执行时,创建新进程，阻塞当前进程</p>
</li>
<li>
<p><code>subprocess.Popen</code>相当于打开一个指定的程序（在 windows 下和<code>os.system</code>有点区别，linux 上有没有区别不知），不阻塞当前进程，创建新进程。<br>
关于上述提的“命令行下执行某个命令”和“打开一个指定程序”的区别在于：</p>
<ol>
<li>前者需要先创建 cmd，再通过 cmd 进程执行命令或打开某个可执行程序，打开可执行程序时时产生的进程作为该 cmd 进程的子进程存在，例如命令行里运行 tomcat 的 catalina，当命令行关闭时 catalina 也关了。</li>
<li>而靠双击打开 catalina 进程则是独立的一个进程。</li>
</ol>
</li>
<li>
<p><code>subprocess.Popen</code>的参数 shell 若设置为 True 时，windows 下相当于在命令前添加了 cmd /c，linux 下相当于添加了/bin/sh -c，即和<code>os.system</code>等效但不会阻塞。（下述情况仅在 windows 下测试存在，linux 未知）这会导致某些情况下返回进程对象的进程号和实际上你执行的命令产生的进程号不一致,获得的事实上是 cmd 程序的进程号。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = subprocess.Popen(<span class="string">'python3 test2.py'</span>,shell = <span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>上述语句其实会创建两个进程，一个 cmd 进程，一个由 cmd 进程创建的 python 子进程<br>
大部分情况下这没问题，父进程会等待子进程结束再结束，当父进程被 kill 子进程也会被 kill</p>
<p>但执行下述语句启动的 flask 进程无法被 kill 掉（具体原因不明）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p = subprocess.Popen(<span class="string">'flask run -h 127.0.0.1 -p 8100'</span>, shell=<span class="keyword">True</span>)</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">time.sleep(<span class="number">5</span>)</span><br><span class="line">p.kill()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="失败原因">失败原因</h3>
<p>以下结论通过打开任务管理器监视不同代码运行时进程情况得出，可能理解有误</p>
<p>程序需要调用命令<code>python3 app.py -p 8080 -h 127.0.0.1</code>，创建一个 web 服务程序的子进程，并且可以在程序中将之关闭，尝试了很多办法都有问题</p>
<p>如下操作，windows 下在子进程中调用<code>os.system</code>时，共存在四个进程，父进程 A，父进程创建的子进程 B，进程 B 通过调用<code>os.system</code>创建的 cmd 进程 C，cmd 进程调用命令产生的子进程 D<br>
父进程调用 kill，则进程 B 被 kill，进程 B 创建的子进程 C 也被销毁，然而 D 幸存</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessCocurrent</span><span class="params">(Process)</span>:</span></span><br><span class="line">    <span class="comment"># ...dosomething</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        os.system(self.cmd)</span><br><span class="line">    <span class="comment"># ...dosomething</span></span><br></pre></td></tr></table></figure>
<p>如下操作，windows 下在子进程中调用<code>os.execvp</code>时子进程被覆盖，pid 改变，在父进程中无法 kill 子进程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessCocurrent</span><span class="params">(Process)</span>:</span></span><br><span class="line">    <span class="comment"># ...dosomething</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        cmdli = self.cmd.split(<span class="string">" "</span>)</span><br><span class="line">        os.execvp(cmdli[<span class="number">0</span>], cmdli)</span><br><span class="line">    <span class="comment"># ...dosomething</span></span><br><span class="line"></span><br><span class="line">p = ProcessCocurrent()</span><br><span class="line">p.start()</span><br><span class="line"><span class="comment"># 下述语句无法终止子进程</span></span><br><span class="line">p.kill()</span><br></pre></td></tr></table></figure>
<p>如下操作，直接调用<code>subprocess.Popen</code>,并设置<code>shell=True</code>，共存在三个进程，父进程 A，<code>subprocess.Popen(cmd, shell = True)</code>创建的 cmd 进程 B，cmd 进程创建的子进程 C。<br>
<code>p.kill()</code>只能杀掉进程 B</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p = subprocess.Popen(cmd, shell = <span class="keyword">True</span>)</span><br><span class="line">p.kill()</span><br></pre></td></tr></table></figure>
<h3 id="正确做法">正确做法</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p = subprocess.Popen(cmd)</span><br><span class="line"><span class="comment"># ...dosomething</span></span><br><span class="line">p.kill()</span><br></pre></td></tr></table></figure>
<p>linux 下还可以用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pid = os.fork()</span><br><span class="line"><span class="keyword">if</span> pid == <span class="number">0</span>:</span><br><span class="line">    os.execvp(<span class="string">'python3'</span>,<span class="string">'python3 app.py -p 8080 -h 127.0.0.1'</span>.split(<span class="string">' '</span>))</span><br><span class="line"><span class="comment"># ...dosomething</span></span><br><span class="line"><span class="comment"># 相当于kill -9 pid</span></span><br><span class="line">os.kill(pid, <span class="number">9</span>)</span><br><span class="line">os.waitpid(pid, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h3 id="debug-模式">debug 模式</h3>
<p>事实上，debug 模式就能监听文件变化并重启程序，由于没看文档绕了上述一个大圈子，可见看文档的重要性。</p>
<p><a href="http://app.py" target="_blank" rel="noopener">app.py</a> 中开启 debug 模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host, port, debug=<span class="keyword">True</span>)</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">app.debug = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>并且其实 flask 官方文档不建议用<code>python app.py</code>启动程序，而是建议通过<code>flask run -h host -p port</code>执行程序。</p>
<p>命令行开启 debug 模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># windows</span></span><br><span class="line"><span class="built_in">set</span> FLASK_DEBUG=<span class="literal">true</span>&amp;&amp;flask run -h host -p port</span><br><span class="line"><span class="comment"># linux</span></span><br><span class="line"><span class="built_in">export</span> FLASK_DEBUG=<span class="literal">true</span>&amp;&amp;flask run -h host -p port</span><br></pre></td></tr></table></figure>
<h2 id="生成-tk-及转码">生成 tk 及转码</h2>
<h3 id="express">express</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; create_tk, tu &#125; = <span class="built_in">require</span>(<span class="string">"./create.js"</span>);</span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">"./util.js"</span>);</span><br><span class="line"><span class="comment">// 请求参数</span></span><br><span class="line"><span class="keyword">const</span> querys = &#123;</span><br><span class="line">  client: <span class="string">"webapp"</span>,</span><br><span class="line">  sl: <span class="string">"zh-CN"</span>, <span class="comment">//source language</span></span><br><span class="line">  tl: <span class="string">"en"</span>, <span class="comment">//target language</span></span><br><span class="line">  hl: <span class="string">"zh-CN"</span>,</span><br><span class="line">  dt: [<span class="string">"t"</span>, <span class="string">"at"</span>, <span class="string">"bd"</span>, <span class="string">"ex"</span>, <span class="string">"ld"</span>, <span class="string">"md"</span>, <span class="string">"qca"</span>, <span class="string">"rw"</span>, <span class="string">"rm"</span>, <span class="string">"sos"</span>, <span class="string">"ss"</span>], <span class="comment">// "t"],</span></span><br><span class="line">  otf: <span class="string">"2"</span>,</span><br><span class="line">  ssel: <span class="string">"3"</span>,</span><br><span class="line">  tsel: <span class="string">"3"</span>,</span><br><span class="line">  xid: <span class="string">"45662847,45683275"</span>,</span><br><span class="line">  kc: <span class="string">"1"</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> url = <span class="string">"https://translate.google.cn/translate_a/single?"</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">app, multipartMiddleware</span>) </span>&#123;</span><br><span class="line">  app.all(<span class="string">"*"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.header(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</span><br><span class="line">    res.header(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"content-type"</span>);</span><br><span class="line">    res.header(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"PUT,POST,GET,DELETE,OPTIONS"</span>);</span><br><span class="line">    res.header(<span class="string">"Content-Type"</span>, <span class="string">"application/json;charset=utf-8"</span>);</span><br><span class="line">    next();</span><br><span class="line">  &#125;);</span><br><span class="line">  app.get(<span class="string">"/getstart"</span>, multipartMiddleware, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; str = <span class="string">""</span> &#125; = req.query;</span><br><span class="line">    <span class="keyword">let</span> query_str = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">const</span> encodeResult = utils.checkEncode(str);</span><br><span class="line">    <span class="keyword">if</span> (encodeResult.indexOf(<span class="string">"gbk"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      str = utils.map2Unicode(utils.encodeISO(str)).join(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 可以是ascii编码的话，一定不存在中文</span></span><br><span class="line">    <span class="keyword">if</span> (encodeResult.indexOf(<span class="string">"ascii"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      querys.sl = <span class="string">"en"</span>;</span><br><span class="line">      querys.tl = <span class="string">"zh-CN"</span>;</span><br><span class="line">      <span class="comment">// 不可以是ascii编码，直接视作中文</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      querys.tl = <span class="string">"en"</span>;</span><br><span class="line">      querys.sl = <span class="string">"zh-CN"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    querys.q = <span class="built_in">encodeURIComponent</span>(str);</span><br><span class="line">    <span class="comment">// 组装get参数</span></span><br><span class="line">    query_str = toqueryurl(querys) + tu(str);</span><br><span class="line">    res.redirect(url + query_str);</span><br><span class="line">  &#125;);</span><br><span class="line">  app.get(<span class="string">"/gettk"</span>, multipartMiddleware, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; str = <span class="string">""</span> &#125; = req.query;</span><br><span class="line">    res.send(create_tk(str));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.js，用以前写好的express模板</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="comment">//返回一个函数</span></span><br><span class="line"><span class="keyword">const</span> multipart = <span class="built_in">require</span>(<span class="string">"connect-multiparty"</span>);</span><br><span class="line"><span class="keyword">const</span> applicationServer = <span class="built_in">require</span>(<span class="string">"./server.js"</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">application</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//监听http请求</span></span><br><span class="line">  <span class="keyword">var</span> app = application || express();</span><br><span class="line">  <span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">"body-parser"</span>);</span><br><span class="line">  <span class="keyword">var</span> multipartMiddleware = multipart(); <span class="comment">//允许参数使用form-data格式,即contentType="multipart/form-data"</span></span><br><span class="line">  <span class="keyword">var</span> server;</span><br><span class="line">  app.use(bodyParser.json(&#123; <span class="attr">limit</span>: <span class="string">"1mb"</span> &#125;)); <span class="comment">//这里指定允许参数使用 json 格式,即contentType="application/json"</span></span><br><span class="line">  app.use(</span><br><span class="line">    bodyParser.urlencoded(&#123;</span><br><span class="line">      extended: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  ); <span class="comment">//这里指定允许www-form-urlencoded格式,即contentType="application/x-www-form-urlencoded"</span></span><br><span class="line"></span><br><span class="line">  applicationServer(app, multipartMiddleware);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!application) &#123;</span><br><span class="line">    server = <span class="built_in">require</span>(<span class="string">"http"</span>).createServer(app);</span><br><span class="line">    server.listen(<span class="number">7070</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"server start at loacalhost:7070"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br><span class="line">start();</span><br></pre></td></tr></table></figure>
<p>然后 pm2 启动<code>pm2 start index.js -o log-file-path -e error-log-path -p pid-file-path -n app-name</code><br>
nginx 反向代理到<code>localhost:7070</code></p>
<details>
<summary>生成tk</summary>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 本来打算理解一下改成lua，觉得有点难，有闲情者可以试试</span></span><br><span class="line"><span class="keyword">var</span> lu = <span class="function"><span class="keyword">function</span> (<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> d = <span class="number">0</span>; c.test(b); ) &#123;</span><br><span class="line">    <span class="keyword">var</span> e = c.lastIndex;</span><br><span class="line">    e &gt; d &amp;&amp; a.push(b.substr(d, e - d));</span><br><span class="line">    d = e;</span><br><span class="line">  &#125;</span><br><span class="line">  b.length &gt; d &amp;&amp; a.push(b.substr(d));</span><br><span class="line">&#125;;</span><br><span class="line">(mu = <span class="regexp">/ /g</span>),</span><br><span class="line">  (nu = <span class="regexp">/([?.,;:!][ ]+)|([\u3001\u3002\uff01\uff08\uff09\uff0c\uff0e\uff1a\uff1b\uff1f][ ]?)/g</span>);</span><br><span class="line"><span class="keyword">var</span> ou = [<span class="number">0</span>, <span class="number">200</span>],</span><br><span class="line">  pu = &#123;</span><br><span class="line">    af: <span class="number">1</span>,</span><br><span class="line">    ar: <span class="number">1</span>,</span><br><span class="line">    bn: <span class="number">1</span>,</span><br><span class="line">    bs: <span class="number">1</span>,</span><br><span class="line">    ca: <span class="number">1</span>,</span><br><span class="line">    cs: <span class="number">1</span>,</span><br><span class="line">    cy: <span class="number">1</span>,</span><br><span class="line">    da: <span class="number">1</span>,</span><br><span class="line">    de: <span class="number">1</span>,</span><br><span class="line">    el: <span class="number">1</span>,</span><br><span class="line">    en: <span class="number">1</span>,</span><br><span class="line">    eo: <span class="number">1</span>,</span><br><span class="line">    es: <span class="number">1</span>,</span><br><span class="line">    et: <span class="number">1</span>,</span><br><span class="line">    fi: <span class="number">1</span>,</span><br><span class="line">    fr: <span class="number">1</span>,</span><br><span class="line">    gu: <span class="number">1</span>,</span><br><span class="line">    hi: <span class="number">1</span>,</span><br><span class="line">    hr: <span class="number">1</span>,</span><br><span class="line">    hu: <span class="number">1</span>,</span><br><span class="line">    hy: <span class="number">1</span>,</span><br><span class="line">    id: <span class="number">1</span>,</span><br><span class="line">    is: <span class="number">1</span>,</span><br><span class="line">    it: <span class="number">1</span>,</span><br><span class="line">    ja: <span class="number">1</span>,</span><br><span class="line">    jw: <span class="number">1</span>,</span><br><span class="line">    km: <span class="number">1</span>,</span><br><span class="line">    kn: <span class="number">1</span>,</span><br><span class="line">    ko: <span class="number">1</span>,</span><br><span class="line">    la: <span class="number">1</span>,</span><br><span class="line">    lv: <span class="number">1</span>,</span><br><span class="line">    mk: <span class="number">1</span>,</span><br><span class="line">    ml: <span class="number">1</span>,</span><br><span class="line">    mr: <span class="number">1</span>,</span><br><span class="line">    my: <span class="number">1</span>,</span><br><span class="line">    ne: <span class="number">1</span>,</span><br><span class="line">    nl: <span class="number">1</span>,</span><br><span class="line">    no: <span class="number">1</span>,</span><br><span class="line">    pl: <span class="number">1</span>,</span><br><span class="line">    pt: <span class="number">1</span>,</span><br><span class="line">    ro: <span class="number">1</span>,</span><br><span class="line">    ru: <span class="number">1</span>,</span><br><span class="line">    si: <span class="number">1</span>,</span><br><span class="line">    sk: <span class="number">1</span>,</span><br><span class="line">    sq: <span class="number">1</span>,</span><br><span class="line">    sr: <span class="number">1</span>,</span><br><span class="line">    su: <span class="number">1</span>,</span><br><span class="line">    sv: <span class="number">1</span>,</span><br><span class="line">    sw: <span class="number">1</span>,</span><br><span class="line">    ta: <span class="number">1</span>,</span><br><span class="line">    te: <span class="number">1</span>,</span><br><span class="line">    th: <span class="number">1</span>,</span><br><span class="line">    tl: <span class="number">1</span>,</span><br><span class="line">    tr: <span class="number">1</span>,</span><br><span class="line">    vi: <span class="number">1</span>,</span><br><span class="line">    uk: <span class="number">1</span>,</span><br><span class="line">    ur: <span class="number">1</span>,</span><br><span class="line">    zh: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"zh-cn"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"zh-tw"</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="keyword">var</span> qu = <span class="function"><span class="keyword">function</span> (<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">ru = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> c = <span class="number">0</span>; c &lt; b.length - <span class="number">2</span>; c += <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> d = b.charAt(c + <span class="number">2</span>);</span><br><span class="line">    d = <span class="string">"a"</span> &lt;= d ? d.charCodeAt(<span class="number">0</span>) - <span class="number">87</span> : <span class="built_in">Number</span>(d);</span><br><span class="line">    d = <span class="string">"+"</span> == b.charAt(c + <span class="number">1</span>) ? a &gt;&gt;&gt; d : a &lt;&lt; d;</span><br><span class="line">    a = <span class="string">"+"</span> == b.charAt(c) ? (a + d) &amp; <span class="number">4294967295</span> : a ^ d;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;;</span><br><span class="line">su = <span class="literal">null</span>;</span><br><span class="line">tu = <span class="function"><span class="keyword">function</span> (<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> !== su) <span class="keyword">var</span> b = su;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    b = qu(<span class="built_in">String</span>.fromCharCode(<span class="number">84</span>));</span><br><span class="line">    <span class="keyword">var</span> c = qu(<span class="built_in">String</span>.fromCharCode(<span class="number">75</span>));</span><br><span class="line">    b = [b(), b()];</span><br><span class="line">    b[<span class="number">1</span>] = c();</span><br><span class="line">    b = (su = <span class="built_in">window</span>[b.join(c())] || <span class="string">""</span>) || <span class="string">""</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> d = qu(<span class="built_in">String</span>.fromCharCode(<span class="number">116</span>));</span><br><span class="line">  c = qu(<span class="built_in">String</span>.fromCharCode(<span class="number">107</span>));</span><br><span class="line">  d = [d(), d()];</span><br><span class="line">  d[<span class="number">1</span>] = c();</span><br><span class="line">  c = <span class="string">"&amp;"</span> + d.join(<span class="string">""</span>) + <span class="string">"="</span>;</span><br><span class="line">  d = b.split(<span class="string">"."</span>);</span><br><span class="line">  b = <span class="built_in">Number</span>(d[<span class="number">0</span>]) || <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> e = [], f = <span class="number">0</span>, g = <span class="number">0</span>; g &lt; a.length; g++) &#123;</span><br><span class="line">    <span class="keyword">var</span> h = a.charCodeAt(g);</span><br><span class="line">    <span class="number">128</span> &gt; h</span><br><span class="line">      ? (e[f++] = h)</span><br><span class="line">      : (<span class="number">2048</span> &gt; h</span><br><span class="line">          ? (e[f++] = (h &gt;&gt; <span class="number">6</span>) | <span class="number">192</span>)</span><br><span class="line">          : (<span class="number">55296</span> == (h &amp; <span class="number">64512</span>) &amp;&amp;</span><br><span class="line">            g + <span class="number">1</span> &lt; a.length &amp;&amp;</span><br><span class="line">            <span class="number">56320</span> == (a.charCodeAt(g + <span class="number">1</span>) &amp; <span class="number">64512</span>)</span><br><span class="line">              ? ((h = <span class="number">65536</span> + ((h &amp; <span class="number">1023</span>) &lt;&lt; <span class="number">10</span>) + (a.charCodeAt(++g) &amp; <span class="number">1023</span>)),</span><br><span class="line">                (e[f++] = (h &gt;&gt; <span class="number">18</span>) | <span class="number">240</span>),</span><br><span class="line">                (e[f++] = ((h &gt;&gt; <span class="number">12</span>) &amp; <span class="number">63</span>) | <span class="number">128</span>))</span><br><span class="line">              : (e[f++] = (h &gt;&gt; <span class="number">12</span>) | <span class="number">224</span>),</span><br><span class="line">            (e[f++] = ((h &gt;&gt; <span class="number">6</span>) &amp; <span class="number">63</span>) | <span class="number">128</span>)),</span><br><span class="line">        (e[f++] = (h &amp; <span class="number">63</span>) | <span class="number">128</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  a = b;</span><br><span class="line">  <span class="keyword">for</span> (f = <span class="number">0</span>; f &lt; e.length; f++) (a += e[f]), (a = ru(a, <span class="string">"+-a^+6"</span>));</span><br><span class="line">  a = ru(a, <span class="string">"+-3^+b+-f"</span>);</span><br><span class="line">  a ^= <span class="built_in">Number</span>(d[<span class="number">1</span>]) || <span class="number">0</span>;</span><br><span class="line">  <span class="number">0</span> &gt; a &amp;&amp; (a = (a &amp; <span class="number">2147483647</span>) + <span class="number">2147483648</span>);</span><br><span class="line">  a %= <span class="number">1e6</span>;</span><br><span class="line">  <span class="keyword">return</span> c + (a.toString() + <span class="string">"."</span> + (a ^ b));</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123; tu &#125;;</span><br></pre></td></tr></table></figure>
</details>
<h3 id="编码转换">编码转换</h3>
<p>可应用于此情况：逐字节读取 gbk 字符串，并转化为 unicode</p>
<p>编码转换一开始找了一堆转换函数，各种各样，我是实在不明白网上那些 utf82gbk,gbk2utf8 的代码到底是怎么回事，他们自己用过吗？<br>
最后发现思路出了问题，unicode 和 gbk 字符集是人定义的，没考虑兼容,不可能存在函数经过一定处理转换两者，一开始搜的不应该是‘gbk 转 unicode’,而应该是 gbk unicode 映射表，一下就找到想要的答案。</p>
<p><a href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WINDOWS/" target="_blank" rel="noopener">映射关系在此，cp 的意思是 code page</a><br>
<a href="https://docs.microsoft.com/zh-cn/windows/win32/intl/code-page-identifiers" target="_blank" rel="noopener">这里是 code page 对应的编码格式</a></p>
<p>gbk 编码范围是单字节 0x00~0x80,双字节高位 0x80~0xfe，低位不能是 0x7f（0x7f 为退格）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">+(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//引入映射关系</span></span><br><span class="line">  <span class="keyword">const</span> codemap = <span class="built_in">require</span>(<span class="string">"./codemap.js"</span>);</span><br><span class="line">  <span class="comment">//测试字符串</span></span><br><span class="line">  <span class="keyword">const</span> str = <span class="string">"asdas¼Ó+Ò»¶þ aÈýËÄÎÊÁùÆßasd\r\n"</span>;</span><br><span class="line">  <span class="keyword">const</span> utils = &#123;</span><br><span class="line">    <span class="comment">// gbk单字节字符码点不大于0x80</span></span><br><span class="line">    <span class="comment">// 双字节字符首字节一定大于0x80</span></span><br><span class="line">    <span class="comment">// 匹配到一个字节大于0x80且（已知其前一个字节不大于0x80||已知其前一个字节属于一个双字节字符的第二个字节）</span></span><br><span class="line">    <span class="comment">// 那么这个字节一定是gbk双字节字符的首字节（编码格式限定在"iso-8859-1", "gbk", "unicode", "ascii"）</span></span><br><span class="line">    <span class="comment">// 逐字节读取转化为双字节gbk的二进制码</span></span><br><span class="line">    encodeISO(str) &#123;</span><br><span class="line">      <span class="keyword">let</span> arr = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> num = str[i].charCodeAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (num &gt; <span class="number">0x80</span>) &#123;</span><br><span class="line">          num &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">          i++;</span><br><span class="line">          num += str[i].charCodeAt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        num = num.toString(<span class="number">16</span>);</span><br><span class="line">        arr.push(</span><br><span class="line">          <span class="string">"0x"</span> + (num.length &gt; <span class="number">2</span> ? num : num.padStart(<span class="number">2</span>, <span class="string">"0"</span>)).toUpperCase()</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// gbk映射到unicode</span></span><br><span class="line">    map2Unicode(arr) &#123;</span><br><span class="line">      arr = arr.map(<span class="function">(<span class="params">item</span>) =&gt;</span> <span class="built_in">String</span>.fromCodePoint(<span class="built_in">parseInt</span>(codemap[item])));</span><br><span class="line">      <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 简单地区分几种编码</span></span><br><span class="line">    checkEncode(arr) &#123;</span><br><span class="line">      <span class="keyword">let</span> encoding = [<span class="string">"iso-8859-1"</span>, <span class="string">"gbk"</span>, <span class="string">"unicode"</span>, <span class="string">"ascii"</span>];</span><br><span class="line">      <span class="keyword">let</span> flag = <span class="number">1</span>;</span><br><span class="line">      <span class="comment">//for of循环能正确识别大于等于二字节的unicode字符</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> chr <span class="keyword">of</span> arr) &#123;</span><br><span class="line">        <span class="keyword">const</span> code_point = chr.codePointAt(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//unicode 存在&gt;0xff</span></span><br><span class="line">        <span class="keyword">if</span> (code_point &gt; <span class="number">0xff</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> [<span class="string">"unicode"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//gbk不存在低位等于0x7f的多字节字符</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (code_point == <span class="number">0x7f</span> &amp;&amp; flag) &#123;</span><br><span class="line">          flag = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">if</span> (encoding.indexOf(<span class="string">"gbk"</span>) &gt; <span class="number">-1</span>)</span><br><span class="line">            encoding.splice(encoding.indexOf(<span class="string">"gbk"</span>), <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ascii 只有&lt;0x80</span></span><br><span class="line">        <span class="comment">//unicode同样未定义0x81-0xff部分</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (code_point &gt; <span class="number">0x80</span>) &#123;</span><br><span class="line">          flag = !flag;</span><br><span class="line">          <span class="keyword">if</span> (encoding.indexOf(<span class="string">"ascii"</span>) &gt; <span class="number">-1</span>)</span><br><span class="line">            encoding.splice(encoding.indexOf(<span class="string">"ascii"</span>), <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> (encoding.indexOf(<span class="string">"unicode"</span>) &gt; <span class="number">-1</span>)</span><br><span class="line">            encoding.splice(encoding.indexOf(<span class="string">"unicode"</span>), <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//iso-8859-1 单字节字符 0x00-0xff 既有&lt;0x40 也有&gt;0x80</span></span><br><span class="line">        <span class="comment">//gbk 存在&gt;0x80 至少&gt;=0x40</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (code_point &lt; <span class="number">0x40</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (encoding.indexOf(<span class="string">"gbk"</span>) &gt; <span class="number">-1</span>)</span><br><span class="line">            encoding.splice(encoding.indexOf(<span class="string">"gbk"</span>), <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          flag = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> encoding;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// console.log(module)</span></span><br><span class="line">  <span class="comment">// console.log(process.argv)</span></span><br><span class="line">  <span class="keyword">if</span> (process.argv.indexOf(<span class="built_in">module</span>.filename) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> result1 = utils.encodeISO(str);</span><br><span class="line">    <span class="keyword">let</span> result2 = utils.map2Unicode(result1);</span><br><span class="line">    <span class="built_in">console</span>.log(result1);</span><br><span class="line">    <span class="built_in">console</span>.log(result2);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">module</span>.exports = utils;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<h2 id="rainmeter-皮肤">rainmeter 皮肤</h2>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Rainmeter]</span></span><br><span class="line"><span class="attr">Update</span>=<span class="number">100</span></span><br><span class="line"><span class="attr">AccurateText</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Metadata]</span></span><br><span class="line"><span class="attr">Name</span>=</span><br><span class="line"><span class="attr">Author</span>=</span><br><span class="line"><span class="attr">Information</span>=</span><br><span class="line"><span class="attr">Version</span>=</span><br><span class="line"><span class="attr">License</span>=Creative Commons Attribution - Non - Commercial - Share Alike <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Variables]</span></span><br><span class="line"><span class="attr">UserInput</span>=<span class="string">"请输入"</span></span><br><span class="line"><span class="attr">BackgroudColor</span>=<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">200</span></span><br><span class="line"><span class="attr">FontColor</span>=<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span></span><br><span class="line"><span class="comment"># 记录点，用于控制计时器</span></span><br><span class="line"><span class="attr">BreakPoint</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">TimerRange</span>=<span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="section">[MStyle]</span></span><br><span class="line"><span class="attr">X</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">Y</span> = <span class="number">30</span>r</span><br><span class="line"><span class="attr">SolidColor</span>=#BackgroudColor#</span><br><span class="line"><span class="attr">FontColor</span>=#FontColor#</span><br><span class="line"><span class="attr">Padding</span>=<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="section">[InputStyle]</span></span><br><span class="line"><span class="attr">X</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">Y</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">W</span>=<span class="number">210</span></span><br><span class="line"><span class="attr">H</span>=<span class="number">15</span></span><br><span class="line"><span class="attr">Padding</span>=<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span></span><br><span class="line"><span class="attr">SolidColor</span>=#BackgroudColor#</span><br><span class="line"><span class="attr">FontColor</span>=#FontColor#</span><br><span class="line"></span><br><span class="line"><span class="comment"># 倒计时器TimerMeasure</span></span><br><span class="line"><span class="comment"># 逻辑如下</span></span><br><span class="line"><span class="comment"># 时钟Clock循环从0到TimerRange变化</span></span><br><span class="line"><span class="comment"># 每次启动TimerMeasure计时器，用BreakPoint记录启动的时刻</span></span><br><span class="line"><span class="comment"># Clock再次等于BreakPoint时计时倒计时停止</span></span><br><span class="line"><span class="comment"># 根据Clock的值和BreakPoint的值计算计时器经过的时间</span></span><br><span class="line"><span class="comment"># 例如BreakPoint为3，Clock为5由于Clock递增可知过去了Clock-BreakPoint=2秒，剩余TimeRange+BreakPoint-Clock秒</span></span><br><span class="line"><span class="comment"># 若BreakPoing为3,Clock为1可知Clock循环了一次回到了1</span></span><br><span class="line"><span class="comment"># 此时经过的时间可用TimerRange-BreakPoint+Clock得出，剩余BreakPoint-Clock秒</span></span><br><span class="line"><span class="section">[Clock]</span></span><br><span class="line"><span class="attr">Measure</span>=Calc</span><br><span class="line"><span class="attr">Formula</span>=(Clock+<span class="number">1</span>)%(#TimerRange#+<span class="number">1</span>)</span><br><span class="line"><span class="attr">DynamicVariables</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">UpdateDivider</span>=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="section">[TimerMeasure]</span></span><br><span class="line"><span class="attr">Measure</span>=Calc</span><br><span class="line"><span class="attr">Formula</span>=#BreakPoint#&gt;Clock?#BreakPoint#-Clock-<span class="number">1</span>:#TimerRange#+#BreakPoint#-Clock</span><br><span class="line"><span class="attr">DynamicVariables</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">UpdateDivider</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">IfEqualValue</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">IfEqualAction</span>=[!PauseMeasure <span class="string">"TimerMeasure"</span>][!HideMeter <span class="string">"MyMeter2"</span>]</span><br><span class="line"><span class="attr">Paused</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 另一个倒计时器，不采用此方法的原因为，无法重置时间，即每次必须倒数完设定的秒数才能重新开始倒数</span></span><br><span class="line"><span class="comment"># 上一个倒计时器可以通过重设breakPoint重置</span></span><br><span class="line"><span class="comment">; [TimerMeasureT]</span></span><br><span class="line"><span class="comment">; Measure=Calc</span></span><br><span class="line"><span class="comment">; Formula=TimerMeasureT&gt;0?TimerMeasureT-1:#TimerRange#</span></span><br><span class="line"><span class="comment">; IfEqualValue=0</span></span><br><span class="line"><span class="comment">; UpdateDivider=10</span></span><br><span class="line"><span class="comment">; DynamicVariables=1</span></span><br><span class="line"><span class="comment">; IfEqualAction=[!HideMeter "MyMeter2"][!PauseMeasure "TimerMeasureT"]</span></span><br><span class="line"><span class="comment">; Paused=1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[JsonMeasure]</span></span><br><span class="line"><span class="attr">Measure</span>=Script</span><br><span class="line"><span class="attr">ScriptFile</span>=script.lua</span><br><span class="line"><span class="attr">DefaultValue</span>=<span class="string">"N/A"</span></span><br><span class="line"><span class="attr">UpdateDivider</span>=-<span class="number">1</span></span><br><span class="line"><span class="attr">OnChangeAction</span>=[!ShowMeter <span class="string">"MyMeter2"</span>][!UpdateMeter <span class="string">"MyMeter2"</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[WebMeasure]</span></span><br><span class="line"><span class="attr">Measure</span>=Plugin</span><br><span class="line"><span class="attr">Plugin</span>=WebParser</span><br><span class="line"><span class="attr">URL</span>=http://localhost:<span class="number">7070</span>/getstart?str=[#UserInput]</span><br><span class="line"><span class="attr">RegExp</span>=(?siU)^(.*)$</span><br><span class="line"><span class="attr">StringIndex</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">ClipString</span>=<span class="number">1</span>;自动换行</span><br><span class="line"><span class="attr">Substitute</span>=<span class="string">""</span>:<span class="string">"N/A"</span></span><br><span class="line"><span class="attr">UserAgent</span>=Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64; rv:<span class="number">73.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">73.0</span></span><br><span class="line"><span class="attr">FinishAction</span>=[!UpdateMeasure <span class="string">"JsonMeasure"</span>][!PauseMeasure <span class="string">"WebMeasure"</span>]</span><br><span class="line"><span class="attr">UpdateDivider</span>=-<span class="number">1</span></span><br><span class="line"><span class="comment">; 动态加载变量</span></span><br><span class="line"><span class="attr">DynamicVariables</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">Paused</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[MeasureInput]</span></span><br><span class="line"><span class="attr">Measure</span>=Plugin</span><br><span class="line"><span class="attr">Plugin</span>=InputText.dll</span><br><span class="line"><span class="attr">X</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">Y</span>=<span class="number">8</span></span><br><span class="line"><span class="attr">W</span>=<span class="number">160</span></span><br><span class="line"><span class="attr">H</span>=<span class="number">15</span></span><br><span class="line"><span class="attr">Padding</span>=<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span></span><br><span class="line"><span class="attr">SolidColor</span>=#BackgroudColor#</span><br><span class="line"><span class="attr">FontColor</span>=#FontColor#</span><br><span class="line"><span class="attr">FontFace</span>=浪漫雅圆</span><br><span class="line"><span class="attr">FontSize</span>=<span class="number">8</span></span><br><span class="line"><span class="attr">FocusDismiss</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">Command1</span>=[!SetVariable UserInput <span class="string">"$UserInput$"</span>][!ShowMeter <span class="string">"DefaultText"</span>][!UpdateMeter <span class="string">"DefaultText"</span>][!UnpauseMeasure <span class="string">"WebMeasure"</span>][!CommandMeasure WebMeasure Update][!UpdateMeasure <span class="string">"WebMeasure"</span>]</span><br><span class="line"><span class="attr">DefaultValue</span>=#UserInput#</span><br><span class="line"><span class="attr">OnDismissAction</span>=[!ShowMeter <span class="string">"DefaultText"</span>][!UpdateMeter <span class="string">"DefaultText"</span>]</span><br><span class="line"><span class="attr">Container</span>=DefaultText</span><br><span class="line"><span class="attr">UpdateDivider</span>=-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[ImageMeter]</span></span><br><span class="line"><span class="attr">Meter</span>=IMAGE</span><br><span class="line"><span class="attr">ImageName</span>=<span class="number">1</span>.png</span><br><span class="line"><span class="attr">Container</span>=ContainerMeter</span><br><span class="line"><span class="attr">UpdateDivider</span>=-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[DefaultText]</span></span><br><span class="line"><span class="attr">Meter</span>=STRING</span><br><span class="line"><span class="attr">MeterStyle</span>=InputStyle</span><br><span class="line"><span class="attr">DynamicVariables</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">Text</span>=#UserInput#</span><br><span class="line"><span class="attr">LeftMouseUpAction</span>=[!HideMeter <span class="string">"DefaultText"</span>][!RainmeterPluginBang <span class="string">"MeasureInput ExecuteBatch 1"</span>]</span><br><span class="line"><span class="attr">Container</span>=ContainerMeter</span><br><span class="line"><span class="attr">UpdateDivider</span>=-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[MyMeter2]</span></span><br><span class="line"><span class="attr">Meter</span>=String</span><br><span class="line"><span class="attr">MeasureName</span>=JsonMeasure</span><br><span class="line"><span class="attr">MeterStyle</span>=MStyle</span><br><span class="line"><span class="attr">Container</span>=ContainerMeter</span><br><span class="line"><span class="attr">UpdateDivider</span>=-<span class="number">1</span></span><br><span class="line"><span class="attr">Hidden</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">; OnUpdateAction=[!UnpauseMeasure "TimerMeasureT"][!SetVariable TimerRange 4]</span></span><br><span class="line"><span class="attr">OnUpdateAction</span>=[!SetVariable BreakPoint [Clock]][!UnpauseMeasure <span class="string">"TimerMeasure"</span>][!SetVariable TimerRange <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[ContainerMeter]</span></span><br><span class="line"><span class="attr">Meter</span>=Shape</span><br><span class="line"><span class="attr">Shape</span>=Rectangle <span class="number">0</span>,<span class="number">0</span>,<span class="number">500</span>,<span class="number">1000</span>,<span class="number">8</span> | Fill Color <span class="number">255</span>,<span class="number">47</span>,<span class="number">47</span>,<span class="number">255</span> | StrokeWidth <span class="number">0</span></span><br><span class="line"><span class="attr">UpdateDivider</span>=-<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>lua 脚本</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Initialize</span><span class="params">()</span></span></span><br><span class="line">    json = <span class="built_in">dofile</span>(SKIN:MakePathAbsolute(<span class="string">'json.lua'</span>))</span><br><span class="line">    encoding = <span class="built_in">dofile</span>(SKIN:MakePathAbsolute(<span class="string">'encoding.lua'</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">concat_means</span><span class="params">(means)</span></span></span><br><span class="line">    <span class="keyword">local</span> result = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> key, mean <span class="keyword">in</span> <span class="built_in">ipairs</span>(means) <span class="keyword">do</span></span><br><span class="line">        result = result .. mean[<span class="number">1</span>] .. <span class="string">": "</span></span><br><span class="line">        <span class="keyword">for</span> key2, mean_content <span class="keyword">in</span> <span class="built_in">ipairs</span>(mean[<span class="number">2</span>]) <span class="keyword">do</span></span><br><span class="line">            result = result .. mean_content .. <span class="string">", "</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        result = result .. <span class="string">"\n"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Update</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> jsonStr = SKIN:GetMeasure(<span class="string">'WebMeasure'</span>):GetStringValue()</span><br><span class="line">    <span class="keyword">local</span> user_input = SKIN:GetVariable(<span class="string">"UserInput"</span>, <span class="string">"N/A"</span>)</span><br><span class="line">    <span class="keyword">if</span> user_input == <span class="string">"N/A"</span> <span class="keyword">or</span> user_input == <span class="string">"请输入"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> user_input</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (jsonStr == <span class="string">"N/A"</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> json_obj = json.decode(jsonStr)</span><br><span class="line">        <span class="keyword">local</span> translate_group = json_obj[<span class="number">2</span>]</span><br><span class="line">        <span class="built_in">print</span>(json_obj[<span class="number">2</span>], json_obj[<span class="number">3</span>])</span><br><span class="line">        <span class="keyword">local</span> result = <span class="string">""</span></span><br><span class="line">        <span class="keyword">local</span> translate = <span class="string">"翻译: "</span> .. json_obj[<span class="number">1</span>][<span class="number">1</span>][<span class="number">1</span>] .. <span class="string">"\n"</span></span><br><span class="line">        <span class="comment">-- 翻译</span></span><br><span class="line">        <span class="keyword">local</span> source_text = <span class="string">"原文: "</span> .. json_obj[<span class="number">1</span>][<span class="number">1</span>][<span class="number">2</span>] .. <span class="string">"\n"</span></span><br><span class="line">        <span class="comment">-- 原文</span></span><br><span class="line">        <span class="keyword">local</span> pinyin = <span class="string">"拼音: "</span> .. json_obj[<span class="number">1</span>][<span class="number">2</span>][<span class="number">4</span>] .. <span class="string">"\n"</span></span><br><span class="line">        <span class="comment">-- 拼音</span></span><br><span class="line">        result = result .. <span class="string">"\n"</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (translate_group == <span class="literal">nil</span>) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> key, group <span class="keyword">in</span> <span class="built_in">ipairs</span>(translate_group) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">local</span> group_name = group[<span class="number">1</span>]</span><br><span class="line">                <span class="keyword">local</span> group_member = group[<span class="number">2</span>]</span><br><span class="line">                <span class="keyword">local</span> group_member_means = group[<span class="number">3</span>]</span><br><span class="line">                result = result .. group_name</span><br><span class="line">                result = result .. <span class="string">"\n"</span></span><br><span class="line">                result = result .. concat_means(group_member_means)</span><br><span class="line">                result = result .. <span class="string">"\n"</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        result = source_text .. pinyin .. translate .. result</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> jsonStr</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>flyingfisherman</h4>
    <p>前端工程师，热爱技术，坚信知识技术改变生活。最高兴的场合莫过于学到的技术为自己、亲友或他人提供了些许的便利、帮助。</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=https://github.flyingfishman.io/hexo/2020/08/08/record/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://github.flyingfishman.io/hexo/2020/08/08/record/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://github.flyingfishman.io/hexo/2020/08/08/record/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/hexo/2020/10/10/runas/">
        ← 当前目录下打开管理员命令行
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/hexo/2020/07/12/vscode/">
        vscode使用 →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h1>

    
</div>
</main>


  
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/hexo/">日常点滴</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/hexo/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/hexo/js/index.js"></script>






</body>
</html>
