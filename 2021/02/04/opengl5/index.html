<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>opengl(5):光照贴图、投光物、多光源 | 土壤细流</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/mynote/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="土壤细流">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml">
  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="rss.xml">
  
  

  
</head>


<body class="post-template">

  <header class="site-head"  style="background-image: url(/mynote/image/cover.jpg)" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/mynote/"><img src="https://avatars.githubusercontent.com/u/26755276" alt="Blog Logo"/></a> 
            <h1 class="blog-title">土壤细流</h1>
            <h2 class="blog-description"></h2>
        </div>
    </div>
</header>
  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2021-02-03T16:00:00.000Z" itemprop="datePublished">
          2021-02-04
      </time>
    
    
    | 
    <a href='/mynote/tags/opengl/'>opengl</a>
    
    
</span>
    <h1 class="post-title">opengl(5):光照贴图、投光物、多光源</h1>
    <section class="post-content">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" /><p>为学懂webgl，从opengl入手。本文内容主要来自<a href="https://learnopengl-cn.github.io/" target="_blank" rel="noopener">LearnOpenGL CN</a>文档，加上个人理解，以及一些细节补充、经验记录。本人学习过程中的详细代码参见<a href="https://github.com/itsnoteasytonameaccount/OpenGL-learning" target="_blank" rel="noopener">此处</a></p>
<p>要学习推荐看原文<a href="https://learnopengl-cn.github.io/" target="_blank" rel="noopener">LearnOpenGL CN</a>，有评论区，加载评论区需要翻墙</p>
<p>另可在<a href="https://www.khronos.org/opengl/wiki/Getting_Started" target="_blank" rel="noopener">此处</a>找到其他opengl官方推荐的资料、教程网站</p>
<a id="more"></a>
<h1>光照贴图</h1>
<p>没什么难搞的地方，直接上代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"LightingMaps.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> glm::mat4 projection;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> WIDTH = <span class="number">800</span>, HEIGHT = <span class="number">600</span>;</span><br><span class="line">static Camera camera(glm::vec3(0.0f, 0.0f, 3.0f));</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *vertex_shader_path = <span class="string">"dist/shader/lighting_maps/lighting_maps.vs"</span>,</span><br><span class="line">                  *fragment_shader_path = <span class="string">"dist/shader/lighting_maps/lighting_maps.fs"</span>,</span><br><span class="line">                  *light_fragment_shader_path = <span class="string">"dist/shader/lighting_maps/lighting_maps_light.fs"</span>,</span><br><span class="line">                  *texture_path = <span class="string">"dist/assets/lighting_maps/container2.png"</span>,</span><br><span class="line">                  *specular_texture_path = <span class="string">"dist/assets/lighting_maps/container2_specular.png"</span>, <span class="comment">//"dist/assets/lighting_maps/lighting_maps_specular_color.png",</span></span><br><span class="line">                  *emission_maps_path = <span class="string">"dist/assets/lighting_maps/matrix.jpg"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _setViewport(GLFWwindow *window, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span><br><span class="line">&#123;</span><br><span class="line">    projection = glm::perspective(glm::radians(camera.getZoom()), (<span class="keyword">float</span>)width / height, <span class="number">0.1f</span>, <span class="number">100.0f</span>);</span><br><span class="line">    WIDTH = width;</span><br><span class="line">    HEIGHT = height;</span><br><span class="line">    glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mouseMove</span><span class="params">(GLFWwindow *window, <span class="keyword">double</span> xpos, <span class="keyword">double</span> ypos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    camera.ProcessMouseMovement(xpos, ypos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scroll</span><span class="params">(GLFWwindow *window, <span class="keyword">double</span> xoffset, <span class="keyword">double</span> yoffset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    camera.ProcessMouseScroll(yoffset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LightingMaps::LightingMaps(<span class="comment">/* args */</span>) : GLWindow(WIDTH, HEIGHT, _setViewport), light_color(glm::vec3(<span class="number">1.0f</span>)), light_pos(glm::vec3(<span class="number">1.2f</span>, <span class="number">1.0f</span>, <span class="number">2.0f</span>)), specular(glm::vec3(<span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>)), box(<span class="number">1</span>), shininess(<span class="number">32.0f</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>-&gt;mouseCallback = mouseMove;</span><br><span class="line">    <span class="keyword">this</span>-&gt;scrollCallback = scroll;</span><br><span class="line"></span><br><span class="line">    initWindow(WIDTH, HEIGHT, <span class="string">"材质场景"</span>);</span><br><span class="line">    glEnable(GL_DEPTH_TEST);</span><br><span class="line">    glClearColor(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    glClearDepth(<span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">    object_shader.readFile(vertex_shader_path, fragment_shader_path);</span><br><span class="line">    light_shader.readFile(vertex_shader_path, light_fragment_shader_path);</span><br><span class="line"></span><br><span class="line">    box.createVAO();</span><br><span class="line"></span><br><span class="line">    texture0num = <span class="number">0</span>;</span><br><span class="line">    texture1num = <span class="number">1</span>;</span><br><span class="line">    texture2num = <span class="number">2</span>;</span><br><span class="line">    Texture::LoadTexture(texture_path, &amp;texture0, <span class="number">1</span>, texture0num);</span><br><span class="line">    Texture::LoadTexture(specular_texture_path, &amp;texture1, <span class="number">1</span>, texture1num);</span><br><span class="line">    Texture::LoadTexture(emission_maps_path, &amp;texture2, <span class="number">1</span>, texture2num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LightingMaps::~LightingMaps()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LightingMaps::draw()</span><br><span class="line">&#123;</span><br><span class="line">    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    glm::<span class="function">mat4 <span class="title">model</span><span class="params">(<span class="number">1.0f</span>)</span></span>;</span><br><span class="line">    glm::mat4 view = camera.getViewMatrix();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// light_color.x = sin(getTime() * 2.0f);</span></span><br><span class="line">    <span class="comment">// light_color.y = sin(getTime() * 0.7f);</span></span><br><span class="line">    <span class="comment">// light_color.z = sin(getTime() * 1.3f);</span></span><br><span class="line"></span><br><span class="line">    object_shader.useProgram();</span><br><span class="line">    object_shader.setUniform3fv(<span class="string">"light.position"</span>, glm::vec3(view * glm::vec4(light_pos, <span class="number">1.0f</span>)));</span><br><span class="line">    object_shader.setUniform3fv(<span class="string">"light.ambient"</span>, light_color * glm::vec3(<span class="number">0.2f</span>));</span><br><span class="line">    object_shader.setUniform3fv(<span class="string">"light.diffuse"</span>, light_color * glm::vec3(<span class="number">0.5f</span>));</span><br><span class="line">    object_shader.setUniform3fv(<span class="string">"light.specular"</span>, glm::vec3(<span class="number">1.0f</span>));</span><br><span class="line">    object_shader.setUniform1i(<span class="string">"material.diffuse"</span>, texture0num);</span><br><span class="line">    object_shader.setUniform1i(<span class="string">"material.specular"</span>, texture1num);</span><br><span class="line">    object_shader.setUniform1i(<span class="string">"emissionMaps"</span>, texture2num);</span><br><span class="line">    object_shader.setUniform1f(<span class="string">"material.shininess"</span>, shininess);</span><br><span class="line">    object_shader.setUniformMatrix4(<span class="string">"projection"</span>, projection);</span><br><span class="line">    object_shader.setUniformMatrix4(<span class="string">"model"</span>, model);</span><br><span class="line">    object_shader.setUniformMatrix4(<span class="string">"view"</span>, view);</span><br><span class="line">    object_shader.setUniformMatrix3(<span class="string">"normalMatrix"</span>, glm::mat3(glm::transpose(glm::inverse(view * model))));</span><br><span class="line">    box.draw();</span><br><span class="line"></span><br><span class="line">    light_shader.useProgram();</span><br><span class="line">    model = glm::translate(model, light_pos);</span><br><span class="line">    model = glm::scale(model, glm::vec3(<span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>));</span><br><span class="line">    light_shader.setUniformMatrix4(<span class="string">"projection"</span>, projection);</span><br><span class="line">    light_shader.setUniformMatrix4(<span class="string">"model"</span>, model);</span><br><span class="line">    light_shader.setUniformMatrix4(<span class="string">"view"</span>, view);</span><br><span class="line">    light_shader.setUniform3fv(<span class="string">"lightColor"</span>, light_color);</span><br><span class="line">    box.draw();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LightingMaps::getKeyInput()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> direction = <span class="number">0x00</span>;</span><br><span class="line">    <span class="keyword">if</span> (getKeyPress(GLFW_KEY_ESCAPE))</span><br><span class="line">    &#123;</span><br><span class="line">        setShouldClose(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getKeyPress(GLFW_KEY_UP, GLFW_PRESS))</span><br><span class="line">    &#123;</span><br><span class="line">        direction |= _CAMERA_UP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getKeyPress(GLFW_KEY_DOWN))</span><br><span class="line">    &#123;</span><br><span class="line">        direction |= _CAMERA_DOWN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getKeyPress(GLFW_KEY_RIGHT))</span><br><span class="line">    &#123;</span><br><span class="line">        direction |= _CAMERA_RIGHT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getKeyPress(GLFW_KEY_LEFT))</span><br><span class="line">    &#123;</span><br><span class="line">        direction |= _CAMERA_LEFT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getKeyPress(GLFW_KEY_W))</span><br><span class="line">    &#123;</span><br><span class="line">        direction |= _CAMERA_FORWARD;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getKeyPress(GLFW_KEY_S))</span><br><span class="line">    &#123;</span><br><span class="line">        direction |= _CAMERA_BACKWARD;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (direction)</span><br><span class="line">    &#123;</span><br><span class="line">        camera.ProcessKeyboardInput(direction, delta);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>顶点着色器</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec3</span> aPos;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">in</span> <span class="type">vec3</span> aNormal;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">2</span>) <span class="keyword">in</span> <span class="type">vec2</span> aTexCoords;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> projection;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> view;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> model;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat3</span> normalMatrix;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec2</span> TexCoords;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec3</span> Normal;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec3</span> FragPos;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">gl_Position</span> = projection * view * model * <span class="type">vec4</span>(aPos, <span class="number">1.0</span>f);</span><br><span class="line">    FragPos = <span class="type">vec3</span>(view * model * <span class="type">vec4</span>(aPos, <span class="number">1.0</span>f));</span><br><span class="line">    Normal = <span class="type">vec3</span>(normalMatrix * aNormal);</span><br><span class="line">    TexCoords = aTexCoords;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>片段着色器</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"></span><br><span class="line">struct Material</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">sampler2D</span> diffuse;</span><br><span class="line">    <span class="type">sampler2D</span> specular;</span><br><span class="line">    <span class="type">float</span> shininess;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Light</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec3</span> position;</span><br><span class="line">    <span class="type">vec3</span> diffuse;</span><br><span class="line">    <span class="type">vec3</span> ambient;</span><br><span class="line">    <span class="type">vec3</span> specular;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> Material material;</span><br><span class="line"><span class="keyword">uniform</span> Light light;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> emissionMaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> <span class="type">vec3</span> FragPos;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec3</span> Normal;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec2</span> TexCoords;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> FragColor;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec3</span> ambient = light.ambient * <span class="type">vec3</span>(<span class="built_in">texture</span>(material.diffuse, TexCoords));</span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> lightDir = <span class="built_in">normalize</span>(light.position - FragPos);</span><br><span class="line">    <span class="type">float</span> diff = <span class="built_in">max</span>(<span class="built_in">dot</span>(lightDir, Normal), <span class="number">0.0</span>f);</span><br><span class="line">    <span class="type">vec3</span> diffuse = light.diffuse * diff * <span class="type">vec3</span>(<span class="built_in">texture</span>(material.diffuse, TexCoords));</span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> viewDir = <span class="built_in">normalize</span>(-FragPos);</span><br><span class="line">    <span class="type">vec3</span> reflectDir = <span class="built_in">reflect</span>(-lightDir, Normal);</span><br><span class="line">    <span class="type">float</span> spec = <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="built_in">dot</span>(reflectDir, viewDir), <span class="number">0.0</span>f), material.shininess);</span><br><span class="line">    <span class="type">vec3</span> specular = light.specular * spec *  <span class="type">vec3</span>(<span class="built_in">texture</span>(material.specular, TexCoords));</span><br><span class="line">    <span class="comment">// vec3 specular = light.specular * spec *  (1 - vec3(texture(material.specular, TexCoords)));</span></span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> emission = <span class="type">vec3</span>(<span class="number">1.0</span>f) *  <span class="type">vec3</span>(<span class="built_in">texture</span>(emissionMaps, TexCoords));</span><br><span class="line"></span><br><span class="line">    FragColor = <span class="type">vec4</span>(specular + diffuse + ambient + emission, <span class="number">1.0</span>f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>光源立方体的顶点着色器</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> FragColor;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    FragColor = <span class="type">vec4</span>(<span class="number">1.0</span>f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>投光物</h1>
<blockquote>
<p>根据本节中的代码可以看到目前所有光照均未考虑不同物体之间遮挡光线的情况。</p>
</blockquote>
<h2 id="平行光">平行光</h2>
<p>平行光比较简单，光线方向向量不需要计算，而是直接从程序中传入片段着色器，在所有位置，光的方向向量都是一致的。</p>
<p><img src="/mynote/image/opengl/light_casters_directional.png" alt="图片无法显示"></p>
<p>根据 opengl 的提示，我们尝试将所有向量改为四分量的，并根据 w 分量是否为 1.0f 判断向量代表光线的位置还是光线的方向以区分光线是点光源或者平行光，修改之后</p>
<p>顶点着色器</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec3</span> aPos;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">in</span> <span class="type">vec3</span> aNormal;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">2</span>) <span class="keyword">in</span> <span class="type">vec2</span> aTexCoords;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> projection;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> view;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> model;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat3</span> normalMatrix;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> Normal;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> FragPos;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec2</span> TexCoords;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    FragPos = view * model * <span class="type">vec4</span>(aPos, <span class="number">1.0</span>f);</span><br><span class="line">    <span class="built_in">gl_Position</span> = projection * FragPos;</span><br><span class="line"></span><br><span class="line">    Normal = <span class="type">vec4</span>(<span class="built_in">normalize</span>(normalMatrix * aNormal), <span class="number">0.0</span>f);</span><br><span class="line">    TexCoords = aTexCoords;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>片段着色器</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"><span class="keyword">in</span> <span class="type">vec2</span> TexCoords;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec4</span> Normal;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec4</span> FragPos;</span><br><span class="line"></span><br><span class="line">struct Light</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec4</span> vector;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Material</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">sampler2D</span> diffuse;</span><br><span class="line">    <span class="type">sampler2D</span> specular;</span><br><span class="line">    <span class="type">float</span> shininess;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> Material material;</span><br><span class="line"><span class="keyword">uniform</span> Light light;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> FragColor;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (light.vector.w == <span class="number">0.0</span>f)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 平行光</span></span><br><span class="line">        lightDir = <span class="built_in">normalize</span>(-light.vector);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (light.vector.w == <span class="number">1.0</span>f)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 点光源</span></span><br><span class="line">        lightDir = <span class="built_in">normalize</span>(light.vector - FragPos);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>c++代码中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object_shader.setUniform4fv(<span class="string">"light.vector"</span>, view * light_pos);</span><br></pre></td></tr></table></figure>
<h2 id="点光源">点光源</h2>
<p>点光源光线强度应当随着距离增加而衰减</p>
<p><img src="/mynote/image/opengl/light_casters_point.png" alt="图片无法显示"></p>
<p>因此需要计算点光源的与物体表面点的距离，用向量长度即可，glsl 提供了向量长度计算公式。</p>
<p>另外还需要一个衰减公式来计算衰减强度，理想的衰减公式应当是在靠近点光源处光线强度随着距离增大变化较快，在远离点光源处光线强度随着距离增大变化较慢，因此公式不应当是线性的</p>
<p>现成的公式</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>F</mi></mstyle><mrow><mi>a</mi><mi>t</mi><mi>t</mi></mrow></msub><mo>=</mo><mfrac><mn>1.0</mn><mrow><msub><mi>K</mi><mi>c</mi></msub><mo>+</mo><msub><mi>K</mi><mi>l</mi></msub><mo>∗</mo><mi>d</mi><mo>+</mo><msub><mi>K</mi><mi>q</mi></msub><mo>∗</mo><msup><mi>d</mi><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">
{\large F}_{att} = \frac{1.0}{K_c + K_l * d + K_q * d^2}

</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969996em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.13889em;">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.293548em;vertical-align:-0.972108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>其中</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span>: 光源到物体表面的距离</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">{\large K}_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969996em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>: 常数项，用于避免分母小于 1，所以一般取 1</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>l</mi></msub></mrow><annotation encoding="application/x-tex">{\large K}_l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969996em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>: 一次项系数，一定距离内当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>l</mi></msub><mo>≫</mo><mn>2</mn><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>q</mi></msub><mo>∗</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">{\large K}_l \gg 2{\large K}_q*d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969996em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≫</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.106104em;vertical-align:-0.286108em;"></span><span class="mord">2</span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span>，一次项对光线强度改变起主导作用</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">{\large K}_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.106104em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>: 二次项系数，一定距离后<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>l</mi></msub><mo>≪</mo><mn>2</mn><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>q</mi></msub><mo>∗</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">{\large K}_l \ll 2{\large K}_q*d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969996em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.106104em;vertical-align:-0.286108em;"></span><span class="mord">2</span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span>，二次项对光线强度改变起主导作用</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>c</mi></msub><mo separator="true">,</mo><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>l</mi></msub><mo separator="true">,</mo><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">{\large K}_c,{\large K}_l,{\large K}_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.106104em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>三者取值及效果表格如下</p>
<table>
<thead>
<tr>
<th style="text-align:left">光线覆盖距离</th>
<th style="text-align:left"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">{\large K}_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969996em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></th>
<th style="text-align:left"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>l</mi></msub></mrow><annotation encoding="application/x-tex">{\large K}_l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969996em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></th>
<th style="text-align:left"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mstyle mathsize="1.2em"><mi>K</mi></mstyle><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">{\large K}_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.106104em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07153em;">K</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.7</td>
<td style="text-align:left">1.8</td>
</tr>
<tr>
<td style="text-align:left">13</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.35</td>
<td style="text-align:left">0.44</td>
</tr>
<tr>
<td style="text-align:left">20</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.22</td>
<td style="text-align:left">0.20</td>
</tr>
<tr>
<td style="text-align:left">32</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.14</td>
<td style="text-align:left">0.07</td>
</tr>
<tr>
<td style="text-align:left">50</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.09</td>
<td style="text-align:left">0.032</td>
</tr>
<tr>
<td style="text-align:left">65</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.07</td>
<td style="text-align:left">0.017</td>
</tr>
<tr>
<td style="text-align:left">100</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.045</td>
<td style="text-align:left">0.0075</td>
</tr>
<tr>
<td style="text-align:left">160</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.027</td>
<td style="text-align:left">0.0028</td>
</tr>
<tr>
<td style="text-align:left">200</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.022</td>
<td style="text-align:left">0.0019</td>
</tr>
<tr>
<td style="text-align:left">325</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.014</td>
<td style="text-align:left">0.0007</td>
</tr>
<tr>
<td style="text-align:left">600</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.007</td>
<td style="text-align:left">0.0002</td>
</tr>
<tr>
<td style="text-align:left">3250</td>
<td style="text-align:left">1.0</td>
<td style="text-align:left">0.0014</td>
<td style="text-align:left">0.000007</td>
</tr>
</tbody>
</table>
<p>在片段着色器中视线衰减如下</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">struct Light &#123;</span><br><span class="line">    <span class="type">vec3</span> vector;  </span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> ambient;</span><br><span class="line">    <span class="type">vec3</span> diffuse;</span><br><span class="line">    <span class="type">vec3</span> specular;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> constant;</span><br><span class="line">    <span class="type">float</span> linear;</span><br><span class="line">    <span class="type">float</span> quadratic;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> <span class="built_in">distance</span> = <span class="number">0.0</span>f, attenuation = <span class="number">1.0</span>f;</span><br><span class="line">    <span class="keyword">if</span> (light.vector.w == <span class="number">0.0</span>f)</span><br><span class="line">    &#123;</span><br><span class="line">        lightDir = <span class="built_in">normalize</span>(-light.vector);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (light.vector.w == <span class="number">1.0</span>f) </span><br><span class="line">    &#123;</span><br><span class="line">        lightDir = light.vector - FragPos;</span><br><span class="line">        <span class="comment">// 内置length函数可以求向量的模</span></span><br><span class="line">        <span class="built_in">distance</span> = <span class="built_in">length</span>(lightDir);</span><br><span class="line">        lightDir = <span class="built_in">normalize</span>(lightDir);</span><br><span class="line">        attenuation = <span class="number">1.0</span>f / (light.constant + light.linear * <span class="built_in">distance</span> + light.quadratic * <span class="built_in">distance</span> * <span class="built_in">distance</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    result = ambient + diffuse + specular;</span><br><span class="line">    FragColor = <span class="type">vec4</span>(result.xyz * attenuation, <span class="number">1.0</span>f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>问题：点光源这一部分引出了一个问题，既然点光源的光在不同距离点处有不同程度的衰减，那么物体漫反射及镜面反射到摄像机前的所有光是否也应该计算一下衰减值（摄像机与某点的距离和点光源到某点的距离是不同的）？计算了会不会显得更真实点？</p>
</blockquote>
<h2 id="聚光">聚光</h2>
<p>聚光为有一定范围的点光源，超过范围只有环境光起作用</p>
<p><img src="/mynote/image/opengl/light_casters_spotlight_angles.png" alt="图片无法显示"></p>
<p>计算聚光需要的增加参数有：聚光锥体的中轴线方向SpotDir；聚光边缘光线方向向量与中轴的夹角，切光角<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ϕ</span></span></span></span>，用弧度表示；</p>
<p>只要光线与中轴的夹角<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span>超过切光角<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ϕ</span></span></span></span>便不计算镜面光照和漫反射。</p>
<p>弧度通过余弦值比较，余弦值通过单位向量点乘来求，即判断方式为</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">dot</span>(-lightDir, SpotDir) &lt; light.cutOff)</span><br><span class="line">&#123;</span><br><span class="line">    result = ambient;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    result = ambient + specular + diffuse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是仅进行如上操作会导致聚光边缘分界明显，不够真实，需要在边缘处进行渐变让光线渐渐变暗</p>
<p>因此添加一个外切光角<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span>，在内切光角内光线强度不随<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span>变化。</p>
<p>内切光角到外且光角之间光线逐渐变暗，渐变公式</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mstyle mathsize="1.2em"><mi>I</mi></mstyle><mo>=</mo><mfrac><mrow><mi>cos</mi><mo>⁡</mo><mi>θ</mi><mo>−</mo><mi>cos</mi><mo>⁡</mo><mi>γ</mi></mrow><mrow><mi>cos</mi><mo>⁡</mo><mi>ϕ</mi><mo>−</mo><mi>cos</mi><mo>⁡</mo><mi>γ</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">{\large I} = \frac{\cos\theta - \cos\gamma}{\cos\phi - \cos\gamma}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.819996em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07847em;">I</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.25188em;vertical-align:-0.8804400000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">cos</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ϕ</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">cos</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>可以看到</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mstyle mathsize="1.2em"><mi>I</mi></mstyle><mo>&lt;</mo><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo separator="true">,</mo><mi>θ</mi><mo>&gt;</mo><mi>γ</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mstyle mathsize="1.2em"><mi>I</mi></mstyle><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo separator="true">,</mo><mi>θ</mi><mo>∈</mo><mo stretchy="false">[</mo><mi>ϕ</mi><mo separator="true">,</mo><mi>γ</mi><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mstyle mathsize="1.2em"><mi>I</mi></mstyle><mo>&gt;</mo><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo separator="true">,</mo><mi>θ</mi><mo>&lt;</mo><mi>ϕ</mi></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{cases}
{\large I} &lt; 0 &amp;,\theta \gt \gamma \\
{\large I} \in [0, 1]&amp;,\theta \in [\phi,\gamma]\\
{\large I} &gt; 1&amp;,\theta \lt \phi
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.9099999999999997em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35002em;"><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.19499em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.20499em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.2950099999999996em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.30501em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.60002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8500199999999998em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.602em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07847em;">I</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span></span></span><span style="top:-3.1620000000000004em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07847em;">I</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span><span style="top:-1.7220000000000004em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal sizing reset-size6 size7" style="margin-right:0.07847em;">I</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9099999999999997em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">[</span><span class="mord mathnormal">ϕ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mclose">]</span></span></span><span style="top:-1.5300000000000002em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9099999999999997em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi><mo>&gt;</mo><mi>γ</mi></mrow><annotation encoding="application/x-tex">\theta &gt; \gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span>时应当只有环境光</p>
<p>修改后聚光在片段着色器中的计算</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> theta = <span class="built_in">dot</span>(-lightDir, <span class="built_in">normalize</span>(light.direction));</span><br><span class="line">    <span class="comment">// clamp函数的作用是将点乘结果限制在一定范围内，如下代码对小于0的取0，大于1的取1</span></span><br><span class="line">    <span class="type">float</span> intensity =  <span class="built_in">clamp</span>((theta - light.outerCutOff)/(light.cutOff - light.outerCutOff), <span class="number">0.0</span>f, <span class="number">1.0</span>f);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    result = <span class="type">vec4</span>((specular + diffuse).xyz * intensity, <span class="number">1.0</span>f) + ambient;</span><br><span class="line"></span><br><span class="line">    FragColor = <span class="type">vec4</span>(result.xyz * attenuation, <span class="number">1.0</span>f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结代码">总结代码</h2>
<p>片段着色器</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"><span class="keyword">in</span> <span class="type">vec2</span> TexCoords;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec4</span> Normal;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec4</span> FragPos;</span><br><span class="line"></span><br><span class="line">struct Light</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec4</span> vector;</span><br><span class="line">    <span class="type">vec4</span> direction;</span><br><span class="line">    <span class="type">float</span> cutOff;</span><br><span class="line">    <span class="type">float</span> outerCutOff;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec4</span> position;</span><br><span class="line">    <span class="type">vec4</span> ambient;</span><br><span class="line">    <span class="type">vec4</span> specular;</span><br><span class="line">    <span class="type">vec4</span> diffuse;</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> constant;</span><br><span class="line">    <span class="type">float</span> linear;</span><br><span class="line">    <span class="type">float</span> quadratic;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Material</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">sampler2D</span> diffuse;</span><br><span class="line">    <span class="type">sampler2D</span> specular;</span><br><span class="line">    <span class="type">float</span> shininess;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> Material material;</span><br><span class="line"><span class="keyword">uniform</span> Light light;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> FragColor;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec4</span> ambient = light.ambient * <span class="built_in">texture</span>(material.diffuse, TexCoords);</span><br><span class="line">    </span><br><span class="line">    <span class="type">vec4</span> lightDir, result;</span><br><span class="line">    <span class="type">float</span> <span class="built_in">distance</span> = <span class="number">0.0</span>f, attenuation = <span class="number">1.0</span>f;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 平行光</span></span><br><span class="line">    <span class="keyword">if</span> (light.vector.w == <span class="number">0.0</span>f)</span><br><span class="line">    &#123;</span><br><span class="line">        lightDir = <span class="built_in">normalize</span>(-light.vector);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 点光</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (light.vector.w == <span class="number">1.0</span>f) </span><br><span class="line">    &#123;</span><br><span class="line">        lightDir = light.vector - FragPos;</span><br><span class="line">        <span class="built_in">distance</span> = <span class="built_in">length</span>(lightDir);</span><br><span class="line">        lightDir = <span class="built_in">normalize</span>(lightDir);</span><br><span class="line">        <span class="comment">// 点光衰减</span></span><br><span class="line">        attenuation = <span class="number">1.0</span>f / (light.constant + light.linear * <span class="built_in">distance</span> + light.quadratic * <span class="built_in">distance</span> * <span class="built_in">distance</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 聚光</span></span><br><span class="line">    <span class="type">float</span> theta = <span class="built_in">dot</span>(-lightDir, <span class="built_in">normalize</span>(light.direction));</span><br><span class="line">    <span class="type">float</span> intensity =  <span class="built_in">clamp</span>((theta - light.outerCutOff)/(light.cutOff - light.outerCutOff), <span class="number">0.0</span>f, <span class="number">1.0</span>f);</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> diff = <span class="built_in">max</span>(<span class="built_in">dot</span>(lightDir, Normal), <span class="number">0.0</span>f);</span><br><span class="line">    <span class="type">vec4</span> diffuse = light.diffuse * diff * <span class="built_in">texture</span>(material.diffuse, TexCoords);</span><br><span class="line"></span><br><span class="line">    <span class="type">vec4</span> viewDir = <span class="built_in">normalize</span>(<span class="type">vec4</span>(<span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f) - FragPos); </span><br><span class="line">    <span class="type">vec4</span> reflectDir = <span class="built_in">reflect</span>(-lightDir, Normal);</span><br><span class="line">    <span class="type">float</span> spec = <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="built_in">dot</span>(reflectDir, viewDir), <span class="number">0.0</span>f), material.shininess);</span><br><span class="line">    <span class="type">vec4</span> specular = light.specular * spec * <span class="built_in">texture</span>(material.specular, TexCoords);</span><br><span class="line"></span><br><span class="line">    result = <span class="type">vec4</span>((specular + diffuse).xyz * intensity, <span class="number">1.0</span>f) + ambient;</span><br><span class="line"></span><br><span class="line">    FragColor = <span class="type">vec4</span>(result.xyz * attenuation, <span class="number">1.0</span>f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>多光源</h1>
<p>使用多个不同光源时可将各自的计算方式封装为函数</p>
<p>建议learn openglcn提供了分别封装的代码，本文出于练手的目的将所有光源抽象为一个结构体</p>
<p>片段着色器如下</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">struct Light</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec4</span> vector;</span><br><span class="line">    <span class="type">vec4</span> direction;</span><br><span class="line">    <span class="type">float</span> cutOff;</span><br><span class="line">    <span class="type">float</span> outerCutOff;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec4</span> ambient;</span><br><span class="line">    <span class="type">vec4</span> specular;</span><br><span class="line">    <span class="type">vec4</span> diffuse;</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> constant;</span><br><span class="line">    <span class="type">float</span> linear;</span><br><span class="line">    <span class="type">float</span> quadratic;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="type">vec3</span> CalcLight(Light light, <span class="type">vec4</span> normal, <span class="type">vec4</span> viewDir, <span class="type">vec4</span> diffuseTexture, <span class="type">vec4</span> specularTexture)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec4</span> ambient = light.ambient * diffuseTexture;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec4</span> lightDir;</span><br><span class="line">    <span class="type">float</span> <span class="built_in">distance</span>, attenuation = <span class="number">1.0</span>f;</span><br><span class="line">    <span class="comment">// 分量为1代表位置向量</span></span><br><span class="line">    <span class="keyword">if</span>(light.vector.w == <span class="number">1.0</span>f)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 点光源或聚光计算衰减</span></span><br><span class="line">        lightDir = light.vector - FragPos;</span><br><span class="line">        <span class="built_in">distance</span> = <span class="built_in">length</span>(lightDir);</span><br><span class="line">        attenuation = <span class="number">1.0</span>f / (light.constant + light.linear * <span class="built_in">distance</span> + light.quadratic * <span class="built_in">distance</span> *<span class="built_in">distance</span>);</span><br><span class="line">        lightDir = <span class="built_in">normalize</span>(lightDir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 平行光</span></span><br><span class="line">        lightDir = <span class="built_in">normalize</span>(-light.vector);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 聚光</span></span><br><span class="line">    <span class="type">float</span> intensity = <span class="number">0.0</span>f, theta = <span class="built_in">dot</span>(light.direction, -lightDir);</span><br><span class="line">    <span class="comment">// 内切光角范围内</span></span><br><span class="line">    <span class="keyword">if</span>(theta &gt;= light.cutOff)</span><br><span class="line">    &#123;</span><br><span class="line">        intensity = <span class="number">1.0</span>f;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 外切光角范围内</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(theta &gt;= light.outerCutOff)</span><br><span class="line">    &#123;</span><br><span class="line">        intensity = (theta - light.outerCutOff)/(light.cutOff - light.outerCutOff);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> diff = <span class="built_in">max</span>(<span class="built_in">dot</span>(lightDir, normal), <span class="number">0.0</span>f);</span><br><span class="line">    <span class="type">vec4</span> diffuse = light.diffuse * diff * diffuseTexture;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec4</span> reflectDir = <span class="built_in">reflect</span>(-lightDir, normal);</span><br><span class="line">    <span class="type">float</span> spec = <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="built_in">dot</span>(reflectDir, viewDir), <span class="number">0.0</span>f), material.shininess);</span><br><span class="line">    <span class="type">vec4</span> specular = light.specular * spec * specularTexture;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> result = (diffuse + specular).xyz * intensity + ambient.xyz;</span><br><span class="line">    <span class="keyword">return</span> result.xyz * attenuation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>c++ 代码中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复制字符串</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;char*&#125; dst 目标数组</span></span><br><span class="line"><span class="comment"> * @param &#123;char*&#125; src 源数据</span></span><br><span class="line"><span class="comment"> * @param &#123;int&#125; start 复制到目标数组的start位置之后</span></span><br><span class="line"><span class="comment"> * @return &#123;int&#125; 返回复制的字符串长度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">str_copy</span><span class="params">(<span class="keyword">char</span> *dst, <span class="keyword">char</span> <span class="keyword">const</span> *src, <span class="keyword">int</span> start)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *p1 = dst + start;</span><br><span class="line">    <span class="keyword">char</span> <span class="keyword">const</span> *p2 = src;</span><br><span class="line">    <span class="keyword">while</span> (*p2 != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *p1++ = *p2++;</span><br><span class="line">    &#125;</span><br><span class="line">    *p1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> p1 - dst;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置光线结构体</span></span><br><span class="line"><span class="keyword">void</span> LightCasters::setLight(<span class="keyword">char</span> <span class="keyword">const</span> *name, <span class="keyword">char</span> index, glm::vec4 <span class="built_in">vector</span>, glm::vec4 color, <span class="keyword">int</span> type)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 设置参数类型</span></span><br><span class="line">    <span class="keyword">int</span> len = str_copy(param, name, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 不同类型的光系数不同</span></span><br><span class="line">    <span class="keyword">float</span> ambient = <span class="number">0.2</span>, diffuse = <span class="number">0.5</span>, specular = <span class="number">1.0f</span>;</span><br><span class="line">    <span class="keyword">if</span> (index)</span><br><span class="line">    &#123;</span><br><span class="line">        param[len++] = <span class="string">'['</span>;</span><br><span class="line">        param[len++] = index;</span><br><span class="line">        param[len++] = <span class="string">']'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    param[len++] = <span class="string">'.'</span>;</span><br><span class="line"></span><br><span class="line">    str_copy(param, <span class="string">"specular"</span>, len);</span><br><span class="line">    object_shader.setUniform4f(param, color.x, color.y, color.z, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">    str_copy(param, <span class="string">"linear"</span>, len);</span><br><span class="line">    object_shader.setUniform1f(param, <span class="number">0.09f</span>);</span><br><span class="line">    str_copy(param, <span class="string">"quadratic"</span>, len);</span><br><span class="line">    object_shader.setUniform1f(param, <span class="number">0.032f</span>);</span><br><span class="line">    str_copy(param, <span class="string">"constant"</span>, len);</span><br><span class="line">    object_shader.setUniform1f(param, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// object_shader.setUniform4f(param, )</span></span><br><span class="line">    <span class="keyword">switch</span> (type)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DIR_LIGHT:</span><br><span class="line">        str_copy(param, <span class="string">"cutOff"</span>, len);</span><br><span class="line">        <span class="comment">// 内切光角设为-1时光线全局有效</span></span><br><span class="line">        object_shader.setUniform1f(param, <span class="number">-1.0f</span>);</span><br><span class="line">        ambient = <span class="number">0.05f</span>;</span><br><span class="line">        diffuse = <span class="number">0.4f</span>;</span><br><span class="line">        specular = <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">        str_copy(param, <span class="string">"vector"</span>, len);</span><br><span class="line">        object_shader.setUniform4f(param, <span class="built_in">vector</span>.x, <span class="built_in">vector</span>.y, <span class="built_in">vector</span>.z, <span class="built_in">vector</span>.w);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SPOT_LIGHT:</span><br><span class="line">        str_copy(param, <span class="string">"vector"</span>, len);</span><br><span class="line">        object_shader.setUniform4f(param, <span class="built_in">vector</span>.x, <span class="built_in">vector</span>.y, <span class="built_in">vector</span>.z, <span class="number">1.0f</span>);</span><br><span class="line">        str_copy(param, <span class="string">"direction"</span>, len);</span><br><span class="line">        object_shader.setUniform4f(param, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">        ambient = <span class="number">0.0f</span>;</span><br><span class="line">        diffuse = <span class="number">1.0f</span>;</span><br><span class="line">        specular = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">        str_copy(param, <span class="string">"cutOff"</span>, len);</span><br><span class="line">        object_shader.setUniform1f(param, glm::<span class="built_in">cos</span>(glm::radians(<span class="number">12.5f</span>)));</span><br><span class="line">        str_copy(param, <span class="string">"outerCutOff"</span>, len);</span><br><span class="line">        object_shader.setUniform1f(param, glm::<span class="built_in">cos</span>(glm::radians(<span class="number">17.5f</span>)));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> POINT_LIGHT:</span><br><span class="line">        str_copy(param, <span class="string">"cutOff"</span>, len);</span><br><span class="line">        object_shader.setUniform1f(param, <span class="number">-1.0f</span>);</span><br><span class="line"></span><br><span class="line">        ambient = <span class="number">0.05f</span>;</span><br><span class="line">        diffuse = <span class="number">0.8f</span>;</span><br><span class="line">        specular = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">        str_copy(param, <span class="string">"vector"</span>, len);</span><br><span class="line">        object_shader.setUniform4f(param, <span class="built_in">vector</span>.x, <span class="built_in">vector</span>.y, <span class="built_in">vector</span>.z, <span class="number">1.0f</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    str_copy(param, <span class="string">"ambient"</span>, len);</span><br><span class="line">    object_shader.setUniform4f(param, ambient * color.x, ambient * color.y, ambient * color.z, <span class="number">1.0f</span>);</span><br><span class="line">    str_copy(param, <span class="string">"diffuse"</span>, len);</span><br><span class="line">    object_shader.setUniform4f(param, diffuse * color.x, diffuse * color.y, diffuse * color.z, <span class="number">1.0f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LightCasters::draw()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    object_shader.useProgram();</span><br><span class="line">    <span class="comment">// 聚光</span></span><br><span class="line">    setLight(<span class="string">"spotLight"</span>, <span class="number">0</span>, glm::vec4(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>), light_color, SPOT_LIGHT);</span><br><span class="line">    <span class="comment">// 平行光</span></span><br><span class="line">    setLight(<span class="string">"dirLight"</span>, <span class="number">0</span>, view * light_direction, light_color, DIR_LIGHT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 点光</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        setLight(<span class="string">"lights"</span>, (<span class="keyword">char</span>)(i + <span class="number">48</span>), view * glm::vec4(pointLightPositions[i], <span class="number">1.0f</span>), light_color, POINT_LIGHT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>参考</h1>
<ol>
<li><a href="https://learnopengl-cn.github.io/02%20Lighting/06%20Multiple%20lights/" target="_blank" rel="noopener">learnOpenGL CN</a></li>
</ol>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>flyingfisherman</h4>
    <p>前端工程师，热爱技术，坚信知识技术改变生活。最高兴的场合莫过于学到的技术为自己、亲友或他人提供了些许的便利、帮助。</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=https://github.flyingfishman.io/mynote/2021/02/04/opengl5/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://github.flyingfishman.io/mynote/2021/02/04/opengl5/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://github.flyingfishman.io/mynote/2021/02/04/opengl5/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/mynote/2021/02/08/opengl6/">
        ← opengl(6):模型加载
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/mynote/2021/01/29/opengl4/">
        opengl(4):颜色、基础光照、材质 →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h1>

    
</div>
</main>


  
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/mynote/">土壤细流</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/mynote/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/mynote/js/index.js"></script>






</body>
</html>
